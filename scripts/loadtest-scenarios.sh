#!/bin/bash

# API Gateway åŽ‹æµ‹åœºæ™¯è„šæœ¬

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOADTEST_SCRIPT="$SCRIPT_DIR/loadtest-wrk.sh"

TARGET_URL="https://api-proxy.pwtk.cc/biz-client/biz/user/self"
CID_HEADER="test-loadtest-$(date +%s)"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                              â•‘"
echo "â•‘                    API Gateway åŽ‹æµ‹åœºæ™¯                                       â•‘"
echo "â•‘                                                                              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# æ£€æŸ¥ wrk æ˜¯å¦å®‰è£…
if ! command -v wrk &> /dev/null; then
    echo -e "${RED}âœ— wrk æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…:${NC}"
    echo "  brew install wrk  # macOS"
    exit 1
fi

echo -e "${BLUE}é€‰æ‹©åŽ‹æµ‹åœºæ™¯:${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  1. ðŸ”¥ è½»é‡çº§åŽ‹æµ‹   (2çº¿ç¨‹, 10è¿žæŽ¥, 30ç§’)  - æµ‹è¯•åŸºæœ¬æ€§èƒ½"
echo "  2. ðŸš€ ä¸­ç­‰åŽ‹åŠ›     (4çº¿ç¨‹, 50è¿žæŽ¥, 60ç§’)  - æ¨¡æ‹Ÿæ­£å¸¸æµé‡"
echo "  3. âš¡ é«˜åŽ‹åŠ›æµ‹è¯•   (8çº¿ç¨‹, 100è¿žæŽ¥, 90ç§’) - æŽ¥è¿‘ç”Ÿäº§å³°å€¼"
echo "  4. ðŸ’¥ æžé™åŽ‹æµ‹     (12çº¿ç¨‹, 200è¿žæŽ¥, 120ç§’) - åŽ‹åŠ›æµ‹è¯•"
echo "  5. ðŸŽ¯ ç¼“å­˜æ•ˆæžœæµ‹è¯• (4çº¿ç¨‹, 20è¿žæŽ¥, 60ç§’)  - å•è·¯å¾„ç¼“å­˜"
echo "  6. ðŸ“Š è‡ªå®šä¹‰é…ç½®"
echo ""
read -p "è¯·é€‰æ‹©åœºæ™¯ (1-6): " choice

case $choice in
    1)
        echo ""
        echo -e "${GREEN}â–¶ åœºæ™¯ 1: è½»é‡çº§åŽ‹æµ‹${NC}"
        echo "  ç”¨é€”: éªŒè¯åŸºæœ¬åŠŸèƒ½ï¼Œæ£€æŸ¥é”™è¯¯çŽ‡"
        echo "  é¢„æœŸ QPS: 100-500"
        echo ""
        "$LOADTEST_SCRIPT" "$TARGET_URL" 2 10 30 "$CID_HEADER"
        ;;
    2)
        echo ""
        echo -e "${GREEN}â–¶ åœºæ™¯ 2: ä¸­ç­‰åŽ‹åŠ›${NC}"
        echo "  ç”¨é€”: æ¨¡æ‹Ÿæ­£å¸¸ä¸šåŠ¡æµé‡"
        echo "  é¢„æœŸ QPS: 500-2000"
        echo ""
        "$LOADTEST_SCRIPT" "$TARGET_URL" 4 50 60 "$CID_HEADER"
        ;;
    3)
        echo ""
        echo -e "${YELLOW}â–¶ åœºæ™¯ 3: é«˜åŽ‹åŠ›æµ‹è¯•${NC}"
        echo "  ç”¨é€”: æŽ¥è¿‘ç”Ÿäº§çŽ¯å¢ƒå³°å€¼æµé‡"
        echo "  é¢„æœŸ QPS: 2000-5000"
        echo "  âš ï¸  å¯èƒ½è§¦å‘é™æµæˆ–ç¼“å­˜å‡»ç©¿"
        echo ""
        "$LOADTEST_SCRIPT" "$TARGET_URL" 8 100 90 "$CID_HEADER"
        ;;
    4)
        echo ""
        echo -e "${YELLOW}â–¶ åœºæ™¯ 4: æžé™åŽ‹æµ‹${NC}"
        echo "  ç”¨é€”: åŽ‹åŠ›æµ‹è¯•ï¼Œå¯»æ‰¾ç³»ç»Ÿç“¶é¢ˆ"
        echo "  é¢„æœŸ QPS: 5000+"
        echo "  âš ï¸  è­¦å‘Š: å¯èƒ½å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œä»…åœ¨æµ‹è¯•çŽ¯å¢ƒä½¿ç”¨ï¼"
        echo ""
        read -p "ç¡®è®¤æ‰§è¡Œæžé™åŽ‹æµ‹? (yes/no): " confirm
        if [[ "$confirm" == "yes" ]]; then
            "$LOADTEST_SCRIPT" "$TARGET_URL" 12 200 120 "$CID_HEADER"
        else
            echo "å·²å–æ¶ˆ"
        fi
        ;;
    5)
        echo ""
        echo -e "${GREEN}â–¶ åœºæ™¯ 5: ç¼“å­˜æ•ˆæžœæµ‹è¯•${NC}"
        echo "  ç”¨é€”: æµ‹è¯•ç¼“å­˜å‘½ä¸­çŽ‡å’Œå“åº”æ—¶é—´"
        echo "  ç‰¹ç‚¹: æ‰€æœ‰è¯·æ±‚éƒ½æ‰“åŒä¸€ä¸ªè·¯å¾„ï¼ˆç›¸åŒ cidï¼‰"
        echo "  é¢„æœŸ: ç¼“å­˜å‘½ä¸­çŽ‡ > 95%, P50 < 20ms"
        echo ""
        "$LOADTEST_SCRIPT" "$TARGET_URL" 4 20 60 "$CID_HEADER"
        
        echo ""
        echo -e "${BLUE}ðŸ’¡ ç¼“å­˜åˆ†æž${NC}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  æŸ¥çœ‹ç¼“å­˜çŠ¶æ€:"
        echo "    curl -I '$TARGET_URL' -H 'cid: $CID_HEADER'"
        echo ""
        echo "  é¢„æœŸå“åº”å¤´:"
        echo "    X-Cache-Status: HIT          # ç¼“å­˜å‘½ä¸­"
        echo "    Age: 15                      # ç¼“å­˜å¹´é¾„ï¼ˆç§’ï¼‰"
        echo "    X-Cache-Remaining-TTL: 285   # å‰©ä½™ TTL"
        echo ""
        ;;
    6)
        echo ""
        echo -e "${BLUE}â–¶ åœºæ™¯ 6: è‡ªå®šä¹‰é…ç½®${NC}"
        echo ""
        read -p "  çº¿ç¨‹æ•° (æŽ¨è: CPUæ ¸å¿ƒæ•°): " threads
        read -p "  å¹¶å‘è¿žæŽ¥æ•°: " connections
        read -p "  æŒç»­æ—¶é—´(ç§’): " duration
        echo ""
        "$LOADTEST_SCRIPT" "$TARGET_URL" "$threads" "$connections" "$duration" "$CID_HEADER"
        ;;
    *)
        echo "æ— æ•ˆçš„é€‰æ‹©"
        exit 1
        ;;
esac

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${GREEN}âœ“ åŽ‹æµ‹å®Œæˆ${NC}"
echo ""

# æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
echo -e "${BLUE}ðŸ“Š æ£€æŸ¥ç¼“å­˜çŠ¶æ€${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹ç¼“å­˜:"
echo "  curl -I '$TARGET_URL' -H 'cid: $CID_HEADER' | grep -E 'X-Cache|Age'"
echo ""

