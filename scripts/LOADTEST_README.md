# API Gateway å‹æµ‹æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº†ä¸¤ä¸ªå‹æµ‹è„šæœ¬ï¼Œç”¨äºæµ‹è¯• API Gateway çš„æ€§èƒ½ï¼š

1. **loadtest-wrk.sh** - åŸºç¡€ wrk å‹æµ‹è„šæœ¬
2. **loadtest-scenarios.sh** - é¢„è®¾åœºæ™¯è„šæœ¬

## å‰ç½®æ¡ä»¶

### å®‰è£… wrk

```bash
# macOS
brew install wrk

# Ubuntu/Debian
sudo apt-get install wrk

# æˆ–ä»æºç ç¼–è¯‘
git clone https://github.com/wg/wrk.git
cd wrk && make
```

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ 1ï¼šä½¿ç”¨é¢„è®¾åœºæ™¯ï¼ˆæ¨èï¼‰

```bash
./scripts/loadtest-scenarios.sh
```

é€‰æ‹©åœºæ™¯ï¼š
- **åœºæ™¯ 1**: è½»é‡çº§ (2çº¿ç¨‹, 10è¿æ¥, 30ç§’) - åˆæ¬¡æµ‹è¯•
- **åœºæ™¯ 2**: ä¸­ç­‰å‹åŠ› (4çº¿ç¨‹, 50è¿æ¥, 60ç§’) - æ­£å¸¸æµé‡
- **åœºæ™¯ 3**: é«˜å‹åŠ› (8çº¿ç¨‹, 100è¿æ¥, 90ç§’) - æ¥è¿‘å³°å€¼
- **åœºæ™¯ 4**: æé™å‹æµ‹ (12çº¿ç¨‹, 200è¿æ¥, 120ç§’) - âš ï¸ è°¨æ…ä½¿ç”¨
- **åœºæ™¯ 5**: ç¼“å­˜æµ‹è¯• (4çº¿ç¨‹, 20è¿æ¥, 60ç§’) - æµ‹è¯•ç¼“å­˜æ•ˆæœ
- **åœºæ™¯ 6**: è‡ªå®šä¹‰é…ç½®

### æ–¹å¼ 2ï¼šç›´æ¥ä½¿ç”¨è„šæœ¬

```bash
./scripts/loadtest-wrk.sh <URL> <çº¿ç¨‹æ•°> <è¿æ¥æ•°> <æ—¶é•¿ç§’> [cid]
```

ç¤ºä¾‹ï¼š

```bash
# è½»é‡çº§å‹æµ‹
./scripts/loadtest-wrk.sh \
  "https://api-proxy.pwtk.cc/biz-client/biz/user/self" \
  2 10 30

# ä¸­ç­‰å‹åŠ›
./scripts/loadtest-wrk.sh \
  "https://api-proxy.pwtk.cc/biz-client/biz/user/self" \
  4 50 60 "custom-cid-123"
```

## å‹æµ‹æµç¨‹å»ºè®®

### ç¬¬ä¸€æ¬¡å‹æµ‹

1. **è½»é‡çº§æµ‹è¯•**ï¼ˆåœºæ™¯ 1ï¼‰
   - ç›®çš„ï¼šéªŒè¯æ¥å£æ˜¯å¦æ­£å¸¸
   - é¢„æœŸï¼šé”™è¯¯ç‡ 0%, P99 < 100ms

2. **è§‚å¯Ÿç¼“å­˜å‘½ä¸­ç‡**
   ```bash
   curl -I 'https://api-proxy.pwtk.cc/biz-client/biz/user/self' \
     -H 'cid: test-cid-123' | grep X-Cache
   ```
   
   é¢„æœŸçœ‹åˆ°ï¼š
   ```
   X-Cache-Status: HIT  # ç¼“å­˜å‘½ä¸­
   Age: 15              # ç¼“å­˜å¹´é¾„ï¼ˆç§’ï¼‰
   X-Cache-TTL: 300     # æ€» TTL
   ```

3. **é€æ­¥å¢åŠ å‹åŠ›**
   - åœºæ™¯ 1 â†’ åœºæ™¯ 2 â†’ åœºæ™¯ 3
   - è§‚å¯Ÿï¼šQPSã€å»¶è¿Ÿã€é”™è¯¯ç‡
   - åœæ­¢æ¡ä»¶ï¼šå‡ºç°é”™è¯¯æˆ–å»¶è¿Ÿé£™å‡

## æ€§èƒ½æŒ‡æ ‡è§£è¯»

### æˆåŠŸæ ‡å‡† âœ…

- é”™è¯¯ç‡ < 1%
- P99 å»¶è¿Ÿ < 200ms
- QPS > 1000ï¼ˆæœ‰ç¼“å­˜ï¼‰
- ç¼“å­˜å‘½ä¸­ç‡ > 95%

### è­¦å‘Šä¿¡å· âš ï¸

- é”™è¯¯ç‡ > 5%
- P99 å»¶è¿Ÿ > 500ms
- QPS æŒç»­ä¸‹é™
- ç¼“å­˜å‘½ä¸­ç‡ < 80%

### ç«‹å³åœæ­¢ ğŸš¨

- é”™è¯¯ç‡ > 10%
- æœåŠ¡å®Œå…¨ä¸å“åº”
- P99 å»¶è¿Ÿ > 2s

## ç¼“å­˜æ•ˆæœå¯¹æ¯”æµ‹è¯•

### A. æµ‹è¯•æœ‰ç¼“å­˜ï¼ˆç›¸åŒ cidï¼‰

```bash
./scripts/loadtest-wrk.sh \
  "https://api-proxy.pwtk.cc/biz-client/biz/user/self" \
  4 50 30 "same-cid-123"
```

é¢„æœŸï¼š
- P50 < 20ms
- ç¼“å­˜å‘½ä¸­ç‡ > 95%
- QPS > 2000

### B. æµ‹è¯•æ— ç¼“å­˜ï¼ˆä¸åŒ cidï¼‰

éœ€è¦ä¿®æ”¹è„šæœ¬åŠ¨æ€ç”Ÿæˆä¸åŒçš„ cidã€‚

é¢„æœŸï¼š
- P50 > 100msï¼ˆéœ€è¦è¯·æ±‚åç«¯ï¼‰
- ç¼“å­˜å‘½ä¸­ç‡æ¥è¿‘ 0%
- QPS < 500

## æ€§èƒ½ç“¶é¢ˆåˆ†æ

### 1. æ£€æŸ¥ç¼“å­˜çŠ¶æ€

```bash
curl -I 'https://api-proxy.pwtk.cc/biz-client/biz/user/self' \
  -H 'cid: test-123' | grep -E "X-Cache-Status|Age"
```

å“åº”å¤´è¯´æ˜ï¼š
- `X-Cache-Status: HIT` - ç¼“å­˜å‘½ä¸­ âœ…ï¼ˆå¿«ï¼‰
- `X-Cache-Status: MISS` - ç¼“å­˜æœªå‘½ä¸­ï¼ˆæ…¢ï¼‰
- `X-Cache-Status: STALE` - è¿‡æœŸç¼“å­˜ï¼Œæ­£åœ¨åˆ·æ–°ï¼ˆä¸­ç­‰ï¼‰

### 2. æ£€æŸ¥é™æµçŠ¶æ€

å¦‚æœå¤§é‡ `429` é”™è¯¯ï¼Œè¯´æ˜è§¦å‘äº†é™æµã€‚

è§£å†³æ–¹æ¡ˆï¼š
- é™ä½å¹¶å‘è¿æ¥æ•°
- å¢åŠ æµ‹è¯•æ—¶é•¿åˆ†æ•£è¯·æ±‚
- è°ƒæ•´é™æµé…ç½®

### 3. æ£€æŸ¥åç«¯æ€§èƒ½

å¦‚æœç¼“å­˜æœªå‘½ä¸­æ—¶å»¶è¿Ÿå¾ˆé«˜ï¼Œé—®é¢˜åœ¨åç«¯ã€‚

### 4. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ

æœ¬åœ°å‹æµ‹å¯ä»¥æ’é™¤ç½‘ç»œå› ç´ ã€‚

## è¿›é˜¶ï¼šAWS Fargate åˆ†å¸ƒå¼å‹æµ‹

å¦‚æœæœ¬åœ°å‹æµ‹é€šè¿‡ï¼Œéœ€è¦æ›´å¤§å‹åŠ›æµ‹è¯•ï¼š

```bash
cd /Users/leo/tk.com/do-for-kv-main/loadtest/aws-fargate-loadtest

# éœ€è¦å…ˆä¿®æ”¹è„šæœ¬æ·»åŠ  cid header æ”¯æŒ
THREADS=8 CONNECTIONS=100 DURATION=90 \
  ./deploy-fargate.sh 100 \
  "https://api-proxy.pwtk.cc/biz-client/biz/user/self"
```

## è¾“å‡ºç¤ºä¾‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    API Gateway æœ¬åœ°å‹æµ‹å·¥å…· (wrk)                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š å‹æµ‹é…ç½®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç›®æ ‡ URL:       https://api-proxy.pwtk.cc/biz-client/biz/user/self
  çº¿ç¨‹æ•°:         4
  å¹¶å‘è¿æ¥æ•°:     50
  æŒç»­æ—¶é—´:       60s
  CID Header:     test-cid-123

Running 60s test @ https://api-proxy.pwtk.cc/biz-client/biz/user/self
  4 threads and 50 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    45.23ms   12.45ms  156.78ms   76.23%
    Req/Sec   275.34     45.67    389.00     68.00%
  65789 requests in 60.00s, 145.67MB read
Requests/sec:   1096.48
Transfer/sec:      2.43MB

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š è¯¦ç»†ç»Ÿè®¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  æ€»è¯·æ±‚æ•°:       65789
  æˆåŠŸè¯·æ±‚:       65789
  å¤±è´¥è¯·æ±‚:       0
  æ€»è€—æ—¶:         60.00s
  æ•°æ®ä¼ è¾“:       145.67 MB

å»¶è¿Ÿåˆ†å¸ƒ:
  P50 (ä¸­ä½æ•°):   42.15ms
  P75:            51.23ms
  P90:            63.45ms
  P99:            98.76ms
  P99.9:          145.23ms
  æœ€å¤§å»¶è¿Ÿ:       156.78ms

ååé‡:
  QPS:            1096.48 req/s
  å¸¦å®½:           2.43 MB/s

æˆåŠŸç‡:          100.00%
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šwrk æœªå®‰è£…

```bash
# macOS
brew install wrk

# Linux
sudo apt-get install wrk
```

### é—®é¢˜ 2ï¼šæ¥å£è¿”å› 729 é”™è¯¯

åŸå› ï¼šç¼ºå°‘ `cid` header

è§£å†³ï¼šè„šæœ¬å·²è‡ªåŠ¨æ·»åŠ ï¼Œæ£€æŸ¥è„šæœ¬æ˜¯å¦æ­£ç¡®æ‰§è¡Œ

### é—®é¢˜ 3ï¼šå¤§é‡ 429 é”™è¯¯

åŸå› ï¼šè§¦å‘é™æµ

è§£å†³ï¼š
- é™ä½å¹¶å‘æ•°
- å¢åŠ æµ‹è¯•æ—¶é—´
- è°ƒæ•´é™æµé…ç½®

### é—®é¢˜ 4ï¼šå»¶è¿Ÿå¾ˆé«˜

å¯èƒ½åŸå› ï¼š
1. ç¼“å­˜æœªç”Ÿæ•ˆï¼ˆæ£€æŸ¥ `X-Cache-Status`ï¼‰
2. åç«¯æ€§èƒ½é—®é¢˜
3. ç½‘ç»œå»¶è¿Ÿ
4. é™æµå¯¼è‡´æ’é˜Ÿ

## æœ€ä½³å®è·µ

1. âœ… **ä»å°å¼€å§‹** - å…ˆæ‰§è¡Œè½»é‡çº§å‹æµ‹
2. âœ… **é€æ­¥å¢åŠ ** - ç¡®è®¤ç¨³å®šåå†åŠ å‹
3. âœ… **ç›‘æ§æŒ‡æ ‡** - å…³æ³¨é”™è¯¯ç‡å’Œå»¶è¿Ÿ
4. âœ… **è§‚å¯Ÿç¼“å­˜** - æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
5. âœ… **åŠæ—¶åœæ­¢** - å‘ç°é—®é¢˜ç«‹å³åœæ­¢

6. âŒ **é¿å…ç›´æ¥æé™å‹æµ‹** - å¯èƒ½å¯¼è‡´æœåŠ¡å´©æºƒ
7. âŒ **ä¸è¦å¿½ç•¥é”™è¯¯** - å³ä½¿å°‘é‡é”™è¯¯ä¹Ÿè¦é‡è§†
8. âŒ **ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒç›²ç›®å‹æµ‹** - ä½¿ç”¨æµ‹è¯•ç¯å¢ƒ

## å‚è€ƒèµ„æ–™

- [wrk å®˜æ–¹æ–‡æ¡£](https://github.com/wg/wrk)
- [HTTP ç¼“å­˜æŒ‡å—](../docs/cache-optimization-strategies.md)
- [Age å“åº”å¤´è¯´æ˜](../docs/cache-debug-headers-guide.md)
- [API å‚è€ƒæ–‡æ¡£](../API_REFERENCE.md)

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- é¡¹ç›®æ–‡æ¡£: `docs/`
- æµ‹è¯•è„šæœ¬: `apps/api/tests/manual/`
- ä»£ç å®¡æŸ¥: `docs/CODE_REVIEW_2025-10-07.md`
