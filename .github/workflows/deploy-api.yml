name: Deploy API to Cloudflare Workers (Production)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å·"
        required: false
        type: string
      change_log:
        description: "å˜æ›´è¯´æ˜"
        required: false
        type: string

permissions:
  contents: write
  actions: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
    - uses: actions/checkout@v4
    
    - name: ç¡®å®šç‰ˆæœ¬å·
      id: version
      run: |
        if [ "${{ github.event.inputs.version }}" != "" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="v$(date +%Y%m%d%H%M%S)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“Œ ç‰ˆæœ¬: $VERSION"
        echo "â˜ï¸  éƒ¨ç½²ç›®æ ‡: Cloudflare Workers (Production)"
        echo "ğŸ”§ æ¡†æ¶: Hono + Durable Objects + KV"
        echo "ğŸ¯ Worker: api-gateway-do-for-kv-production"
        echo "ğŸ“ Monorepo: apps/api"
        echo "ğŸ“¦ åŒ…ç®¡ç†å™¨: pnpm"

  request-approval:
    needs: build
    uses: ./.github/workflows/reusable-lark-approval.yml
    with:
      project_type: workers
      project_name: api-gateway-do-for-kv-production
      version: ${{ needs.build.outputs.version }}
      change_log: ${{ github.event.inputs.change_log || 'Production deployment' }}
    secrets:
      LARK_APP_ID: ${{ secrets.LARK_APP_ID }}
      LARK_APP_SECRET: ${{ secrets.LARK_APP_SECRET }}
      LARK_CHAT_ID: ${{ secrets.LARK_CHAT_ID }}
      APPROVAL_CALLBACK_BASE: ${{ secrets.APPROVAL_CALLBACK_BASE }}
      CALLBACK_SIGN: ${{ secrets.CALLBACK_SIGN }}

  deploy:
    needs: [build, request-approval]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
    
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
    
    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
    
    - name: Check project structure
      run: |
        echo "ğŸ“ é¡¹ç›®æ ¹ç›®å½•:"
        ls -la
        echo ""
        echo "ğŸ“„ pnpm-workspace.yaml:"
        if [ -f "pnpm-workspace.yaml" ]; then
          cat pnpm-workspace.yaml
        fi
        echo ""
        echo "ğŸ“„ æ ¹ç›®å½• package.json:"
        if [ -f "package.json" ]; then
          cat package.json | head -20
        fi
    
    - name: Install dependencies with pnpm
      run: |
        echo "ğŸ“¦ ä½¿ç”¨ pnpm å®‰è£… Monorepo ä¾èµ–..."
        pnpm install --no-frozen-lockfile
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
    
    - name: Verify dependencies
      working-directory: apps/api
      run: |
        echo "ğŸ” éªŒè¯ä¾èµ–å®‰è£…:"
        echo ""
        echo "ğŸ“¦ æ£€æŸ¥ hono:"
        if [ -d "../../node_modules/hono" ]; then
          echo "âœ… hono å­˜åœ¨äºæ ¹ç›®å½• node_modules"
        fi
        if [ -d "node_modules/hono" ]; then
          echo "âœ… hono å­˜åœ¨äº apps/api/node_modules"
        fi
        echo ""
        echo "ğŸ“¦ æ£€æŸ¥ wrangler:"
        if command -v pnpm exec wrangler &> /dev/null; then
          echo "âœ… wrangler å¯ç”¨"
          pnpm exec wrangler --version
        fi
    
    - name: Check Wrangler Config
      working-directory: apps/api
      run: |
        echo "ğŸ“„ Wrangler Config:"
        cat wrangler.toml
        echo ""
        echo "âœ… Config verified"
    
    - name: Deploy to Cloudflare Workers (production)
      working-directory: apps/api
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Cloudflare Workers..."
        echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
        echo ""
        pnpm exec wrangler deploy --env production
        echo ""
        echo "âœ… éƒ¨ç½²å®Œæˆ"
    
    - name: Create Release
      if: success()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          try {
            const version = '${{ needs.build.outputs.version }}';
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: 'Release ' + version,
              body: 'Production Deployment - API Worker - Version: ' + version,
              draft: false,
              prerelease: false
            });
            console.log('âœ… Release created successfully');
          } catch (error) {
            console.log('Release creation skipped:', error.message);
          }

  notify-lark:
    needs: [build, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Lark Notification
        env:
          LARK_APP_ID: ${{ secrets.LARK_APP_ID }}
          LARK_APP_SECRET: ${{ secrets.LARK_APP_SECRET }}
          LARK_CHAT_ID: ${{ secrets.LARK_CHAT_ID }}
        run: |
          command -v jq >/dev/null 2>&1 || {
            sudo apt-get update -y >/dev/null
            sudo apt-get install -y jq >/dev/null
          }
          
          TAT="$(curl -sS -X POST 'https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal' \
            -H 'Content-Type: application/json; charset=utf-8' \
            -d "{\"app_id\":\"${LARK_APP_ID}\",\"app_secret\":\"${LARK_APP_SECRET}\"}" | jq -r '.tenant_access_token')"
          
          if [ -n "$TAT" ] && [ "$TAT" != "null" ]; then
            if [ "${{ needs.deploy.result }}" = "success" ]; then
              STATUS_MSG="[api-gateway-do-for-kv-production] âœ… Production éƒ¨ç½²æˆåŠŸ - ç‰ˆæœ¬: ${{ needs.build.outputs.version }} - Worker: api-gateway-do-for-kv-production"
            else
              STATUS_MSG="[api-gateway-do-for-kv-production] âŒ Production éƒ¨ç½²å¤±è´¥ - ç‰ˆæœ¬: ${{ needs.build.outputs.version }}"
            fi
            
            curl -sS -X POST 'https://open.larksuite.com/open-apis/im/v1/messages?receive_id_type=chat_id' \
              -H "Authorization: Bearer ${TAT}" \
              -H 'Content-Type: application/json; charset=utf-8' \
              -d "{
                \"receive_id\": \"${LARK_CHAT_ID}\",
                \"msg_type\": \"text\",
                \"content\": \"{\\\"text\\\":\\\"${STATUS_MSG}\\\"}\"
              }"
            
            echo "âœ… é£ä¹¦é€šçŸ¥å·²å‘é€: ${STATUS_MSG}"
          else
            echo "âš ï¸ æ— æ³•è·å–é£ä¹¦ tokenï¼Œè·³è¿‡é€šçŸ¥"
          fi
