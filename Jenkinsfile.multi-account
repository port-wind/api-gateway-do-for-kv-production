#!/usr/bin/env groovy

/**
 * API Gateway Jenkins éƒ¨ç½²æµæ°´çº¿ - å¤šè´¦å·æ”¯æŒç‰ˆæœ¬
 * 
 * æ”¯æŒ:
 * - æµ‹è¯•ç¯å¢ƒ (625675bb221d602eccde58bb23facbfb)
 * - ç”Ÿäº§ç¯å¢ƒ (80e68ad465093681d7d893b6c122f9b8)
 * - è‡ªåŠ¨é€‰æ‹©å¯¹åº”è´¦å·çš„ API Token
 * - å‚æ•°åŒ–éƒ¨ç½²
 */

pipeline {
    agent any
    
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['test', 'production'],
            description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        )
        choice(
            name: 'DEPLOY_TARGET',
            choices: ['all', 'api', 'web'],
            description: 'é€‰æ‹©éƒ¨ç½²ç›®æ ‡'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'è·³è¿‡æµ‹è¯•ï¼ˆä¸æ¨èï¼‰'
        )
    }
    
    environment {
        // æ ¹æ®ç¯å¢ƒå‚æ•°åŠ¨æ€é€‰æ‹© Cloudflare å‡­è¯
        CLOUDFLARE_API_TOKEN = credentials(
            params.ENVIRONMENT == 'production' 
                ? 'cloudflare-api-token-prod' 
                : 'cloudflare-api-token-test'
        )
        
        // è®¾ç½®å¯¹åº”çš„è´¦å· ID
        CLOUDFLARE_ACCOUNT_ID = params.ENVIRONMENT == 'production' 
            ? '80e68ad465093681d7d893b6c122f9b8'
            : '625675bb221d602eccde58bb23facbfb'
        
        // é£ä¹¦ Webhookï¼ˆå¯é€‰ï¼‰
        LARK_WEBHOOK_URL = credentials('lark-webhook-url')
        
        // æ„å»ºä¿¡æ¯
        BUILD_USER = "${env.BUILD_USER_ID ?: 'jenkins'}"
        GIT_COMMIT_SHORT = sh(script: "git log -1 --pretty=format:'%h'", returnStdout: true).trim()
        GIT_COMMIT_MSG = sh(script: "git log -1 --pretty=format:'%s'", returnStdout: true).trim()
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
        timestamps()
    }
    
    stages {
        stage('åˆå§‹åŒ–') {
            steps {
                script {
                    // æ ¹æ®ç¯å¢ƒè®¾ç½®å›¾æ ‡å’Œåç§°
                    def envIcon = params.ENVIRONMENT == 'production' ? 'ğŸŸ¢' : 'ğŸŸ¡'
                    def envName = params.ENVIRONMENT == 'production' ? 'ç”Ÿäº§ç¯å¢ƒ' : 'æµ‹è¯•ç¯å¢ƒ'
                    def envEmail = params.ENVIRONMENT == 'production' ? 'portwind520@gmail.com' : 'æµ‹è¯•è´¦å·'
                    
                    echo """
                    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    ğŸš€ API Gateway éƒ¨ç½²æµæ°´çº¿
                    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    ${envIcon} ç¯å¢ƒ:      ${envName}
                    ğŸ“§ è´¦å·:      ${envEmail}
                    ğŸ”‘ Account ID: ${env.CLOUDFLARE_ACCOUNT_ID}
                    ğŸ¯ éƒ¨ç½²ç›®æ ‡:  ${params.DEPLOY_TARGET}
                    ğŸ“¦ æ„å»ºå·:    #${env.BUILD_NUMBER}
                    ğŸŒ¿ åˆ†æ”¯:      ${env.GIT_BRANCH}
                    ğŸ“ æäº¤:      ${env.GIT_COMMIT_SHORT}
                    ğŸ‘¤ è§¦å‘è€…:    ${env.BUILD_USER}
                    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    """
                }
            }
        }
        
        stage('ç”Ÿäº§ç¯å¢ƒç¡®è®¤') {
            when {
                expression { params.ENVIRONMENT == 'production' }
            }
            steps {
                script {
                    // ç”Ÿäº§ç¯å¢ƒéœ€è¦é¢å¤–ç¡®è®¤
                    timeout(time: 5, unit: 'MINUTES') {
                        input(
                            message: 'âš ï¸  ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ',
                            ok: 'ç¡®è®¤éƒ¨ç½²',
                            submitter: 'admin'  // å¯ä»¥é™åˆ¶åªæœ‰ç‰¹å®šç”¨æˆ·æ‰èƒ½ç¡®è®¤
                        )
                    }
                    echo 'âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å·²ç¡®è®¤'
                }
            }
        }
        
        stage('æ£€å‡ºä»£ç ') {
            steps {
                checkout scm
            }
        }
        
        stage('ç¯å¢ƒæ£€æŸ¥') {
            steps {
                sh '''
                    echo "ğŸ“‹ æ£€æŸ¥ç¯å¢ƒ..."
                    
                    # æ£€æŸ¥ Node.js
                    if ! command -v node &> /dev/null; then
                        echo "âŒ Node.js æœªå®‰è£…"
                        exit 1
                    fi
                    echo "âœ… Node.js: $(node --version)"
                    
                    # æ£€æŸ¥/å®‰è£… pnpm
                    if ! command -v pnpm &> /dev/null; then
                        echo "âš™ï¸  å®‰è£… pnpm..."
                        npm install -g pnpm
                    fi
                    echo "âœ… pnpm: $(pnpm --version)"
                    
                    # æ£€æŸ¥/å®‰è£… wrangler
                    if ! command -v wrangler &> /dev/null; then
                        echo "âš™ï¸  å®‰è£… wrangler..."
                        npm install -g wrangler
                    fi
                    echo "âœ… wrangler: $(wrangler --version)"
                    
                    # æ˜¾ç¤ºå½“å‰è´¦å·ä¿¡æ¯
                    echo ""
                    echo "ğŸ”‘ Cloudflare è´¦å·ä¿¡æ¯:"
                    echo "   Account ID: $CLOUDFLARE_ACCOUNT_ID"
                '''
            }
        }
        
        stage('å®‰è£…ä¾èµ–') {
            steps {
                sh '''
                    echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
                    pnpm install --frozen-lockfile --prefer-offline
                '''
            }
        }
        
        stage('è¿è¡Œæµ‹è¯•') {
            when {
                expression { !params.SKIP_TESTS }
            }
            steps {
                sh '''
                    echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
                    pnpm run test:api:unit || {
                        echo "âŒ æµ‹è¯•å¤±è´¥"
                        exit 1
                    }
                '''
            }
        }
        
        stage('éƒ¨ç½²') {
            steps {
                script {
                    def envFlag = params.ENVIRONMENT == 'production' ? '--env production' : ''
                    def envIcon = params.ENVIRONMENT == 'production' ? 'ğŸŸ¢' : 'ğŸŸ¡'
                    
                    switch(params.DEPLOY_TARGET) {
                        case 'all':
                            echo "${envIcon} éƒ¨ç½² API + Webï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰"
                            // å¯¹äº all æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ API ä½¿ç”¨æ­£ç¡®çš„ç¯å¢ƒ
                            if (params.ENVIRONMENT == 'production') {
                                sh '''
                                    # API éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
                                    cd apps/api
                                    wrangler deploy --env production
                                    cd ../..
                                    
                                    # Web éƒ¨ç½²
                                    pnpm run deploy:web
                                '''
                            } else {
                                sh 'pnpm run deploy'
                            }
                            break
                            
                        case 'api':
                            echo "${envIcon} åªéƒ¨ç½² API"
                            sh """
                                cd apps/api
                                wrangler deploy ${envFlag}
                            """
                            break
                            
                        case 'web':
                            echo "${envIcon} åªéƒ¨ç½² Web"
                            sh 'pnpm run deploy:web'
                            break
                            
                        default:
                            error "æœªçŸ¥çš„éƒ¨ç½²ç›®æ ‡: ${params.DEPLOY_TARGET}"
                    }
                }
            }
        }
        
        stage('éªŒè¯éƒ¨ç½²') {
            when {
                expression { params.DEPLOY_TARGET == 'api' || params.DEPLOY_TARGET == 'all' }
            }
            steps {
                script {
                    echo 'ğŸ” éªŒè¯ API éƒ¨ç½²...'
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å¥åº·æ£€æŸ¥
                    // ä¾‹å¦‚ï¼šcurl æµ‹è¯•éƒ¨ç½²çš„ Worker æ˜¯å¦æ­£å¸¸å“åº”
                }
            }
        }
    }
    
    post {
        success {
            script {
                def envIcon = params.ENVIRONMENT == 'production' ? 'ğŸŸ¢' : 'ğŸŸ¡'
                def envName = params.ENVIRONMENT == 'production' ? 'ç”Ÿäº§ç¯å¢ƒ' : 'æµ‹è¯•ç¯å¢ƒ'
                
                def message = """
                âœ… API Gateway éƒ¨ç½²æˆåŠŸ
                
                ${envIcon} ç¯å¢ƒ: ${envName}
                ğŸ¯ ç›®æ ‡: ${params.DEPLOY_TARGET}
                ğŸ“¦ æ„å»º: #${env.BUILD_NUMBER}
                ğŸŒ¿ åˆ†æ”¯: ${env.GIT_BRANCH}
                ğŸ“ æäº¤: ${env.GIT_COMMIT_SHORT} - ${env.GIT_COMMIT_MSG}
                ğŸ‘¤ è§¦å‘: ${env.BUILD_USER}
                â±ï¸  è€—æ—¶: ${currentBuild.durationString.replace(' and counting', '')}
                """
                
                echo message
                
                // å‘é€é£ä¹¦é€šçŸ¥
                if (env.LARK_WEBHOOK_URL) {
                    sh """
                        curl -X POST '${env.LARK_WEBHOOK_URL}' \
                        -H 'Content-Type: application/json' \
                        -d '{
                            "msg_type": "text",
                            "content": {
                                "text": "${message.replaceAll('"', '\\\\"').replaceAll('\n', '\\\\n')}"
                            }
                        }'
                    """
                }
            }
        }
        
        failure {
            script {
                def envIcon = params.ENVIRONMENT == 'production' ? 'ğŸŸ¢' : 'ğŸŸ¡'
                def envName = params.ENVIRONMENT == 'production' ? 'ç”Ÿäº§ç¯å¢ƒ' : 'æµ‹è¯•ç¯å¢ƒ'
                
                def message = """
                âŒ API Gateway éƒ¨ç½²å¤±è´¥
                
                ${envIcon} ç¯å¢ƒ: ${envName}
                ğŸ¯ ç›®æ ‡: ${params.DEPLOY_TARGET}
                ğŸ“¦ æ„å»º: #${env.BUILD_NUMBER}
                ğŸ‘¤ è§¦å‘: ${env.BUILD_USER}
                
                ğŸ”— æŸ¥çœ‹æ—¥å¿—: ${env.BUILD_URL}console
                """
                
                echo message
                
                // å‘é€é£ä¹¦é€šçŸ¥
                if (env.LARK_WEBHOOK_URL) {
                    sh """
                        curl -X POST '${env.LARK_WEBHOOK_URL}' \
                        -H 'Content-Type: application/json' \
                        -d '{
                            "msg_type": "text",
                            "content": {
                                "text": "${message.replaceAll('"', '\\\\"').replaceAll('\n', '\\\\n')}"
                            }
                        }'
                    """
                }
            }
        }
        
        always {
            echo 'ğŸ§¹ æ¸…ç†å·¥ä½œ...'
        }
    }
}
