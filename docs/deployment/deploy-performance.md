# 部署性能对比

## 🚀 并行 vs 串行部署

### 串行部署（默认）

```
时间轴：
┌─────────────────────┐
│   部署 API (10s)    │
└─────────────────────┘
                      ┌─────────────────────┐
                      │   部署 Web (15s)    │
                      └─────────────────────┘
                      
总耗时：10s + 15s = 25秒
```

```bash
pnpm run deploy
```

### 并行部署（推荐）⚡

```
时间轴：
┌─────────────────────┐
│   部署 API (10s)    │
└─────────────────────┘
┌─────────────────────────────┐
│      部署 Web (15s)         │
└─────────────────────────────┘

总耗时：max(10s, 15s) = 15秒
节省时间：25s - 15s = 10秒 (40%)
```

```bash
pnpm run deploy:parallel
```

## 📊 实际案例

假设：
- API 部署需要 10 秒
- Web 部署需要 15 秒

| 部署方式 | 总耗时 | 节省时间 | 性能提升 |
|---------|--------|----------|---------|
| 串行部署 | 25秒   | -        | -       |
| 并行部署 | 15秒   | 10秒     | 40%     |

## 🎯 使用建议

### 推荐使用并行部署

```bash
pnpm run deploy:parallel
```

**优点：**
- ⚡ 更快：节省 30-50% 的时间
- 💪 高效：充分利用系统资源
- ✅ 可靠：失败会立即报告

**何时使用：**
- 日常开发部署
- 快速迭代
- CI/CD 自动部署

### 使用串行部署

```bash
pnpm run deploy
```

**优点：**
- 🛡️ 稳定：按顺序执行，更容易追踪
- 📝 清晰：输出按顺序显示
- 🔍 调试：便于定位问题

**何时使用：**
- 首次部署
- 调试问题
- 需要详细日志

## 💡 性能优化技巧

### 1. 跳过依赖安装（如果依赖未变）

如果你确定依赖没有变化，可以跳过安装：

```bash
bash scripts/deploy-web-to-197.sh --skip-install
```

### 2. 只部署变化的部分

```bash
# 只改了 API
pnpm run deploy:api

# 只改了 Web
pnpm run deploy:web:197
```

### 3. 本地构建 + 快速部署

```bash
# 先在本地构建好
pnpm --filter @gateway/web build

# 然后快速部署（跳过构建步骤）
bash scripts/deploy-web-to-197.sh --skip-install
```

## 🔧 技术实现

并行部署使用 Bash 后台进程：

```bash
# 后台启动 API 部署
bash deploy-api.sh &
API_PID=$!

# 后台启动 Web 部署  
bash deploy-web.sh &
WEB_PID=$!

# 等待两个进程完成
wait $API_PID
wait $WEB_PID
```

## 📈 预期性能提升

根据典型部署时间：

| 场景 | API 耗时 | Web 耗时 | 串行总计 | 并行总计 | 提升 |
|-----|---------|---------|---------|---------|------|
| 小改动 | 8s  | 12s | 20s | 12s | 40% |
| 中等改动 | 15s | 25s | 40s | 25s | 37.5% |
| 大改动 | 30s | 45s | 75s | 45s | 40% |

## 🎬 快速开始

试试并行部署：

```bash
pnpm run deploy:parallel
```

你会看到：
- 两个部署同时开始
- 实时显示进度
- 自动等待全部完成
- 显示节省的时间

## 🐛 故障排查

### 并行部署失败？

回退到串行模式：

```bash
pnpm run deploy
```

### 需要查看详细日志？

并行模式会将日志保存到临时文件，失败时自动显示。

### 想看实时输出？

使用串行模式可以看到实时输出：

```bash
pnpm run deploy
```
