# çµæ´»ç¼“å­˜é”®ç­–ç•¥ - åŠŸèƒ½è®¾è®¡ä¸å®æ–½æ–‡æ¡£

**åˆ†æ”¯åç§°**: `feature/flexible-cache-key-strategy`  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-02  
**çŠ¶æ€**: ğŸš§ å¼€å‘ä¸­

## ğŸ“‹ ç›®å½•

- [èƒŒæ™¯ä¸é—®é¢˜](#èƒŒæ™¯ä¸é—®é¢˜)
- [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
- [æŠ€æœ¯è®¾è®¡](#æŠ€æœ¯è®¾è®¡)
- [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
- [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
- [è¿ç§»æŒ‡å—](#è¿ç§»æŒ‡å—)
- [å›æ»šæ–¹æ¡ˆ](#å›æ»šæ–¹æ¡ˆ)

---

## èƒŒæ™¯ä¸é—®é¢˜

### å½“å‰æ¶æ„çš„å±€é™æ€§

ç°æœ‰çš„ç¼“å­˜ç³»ç»Ÿä½¿ç”¨å›ºå®šçš„ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥ï¼š`cache:v{version}:{path}:{paramsHash}`

è¿™ç§ç­–ç•¥å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç”¨æˆ·éš”ç¦»ä¸è¶³**
   - ç¤ºä¾‹ï¼š`/biz-client/biz/user/self` è¿”å›å½“å‰ç”¨æˆ·ä¿¡æ¯
   - é—®é¢˜ï¼šä¸åŒç”¨æˆ·è®¿é—®åŒä¸€è·¯å¾„ï¼Œéœ€è¦æ ¹æ® `Authorization` header ä¸­çš„ token ç”Ÿæˆä¸åŒç¼“å­˜
   - å½“å‰è¡Œä¸ºï¼šæ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ªç¼“å­˜ âŒ

2. **POST è¯·æ±‚ç¼“å­˜ä¸çµæ´»**
   - ç¤ºä¾‹ï¼š`/biz-client/biz/issueReplayVideo/list` (POST)
   - é—®é¢˜ï¼šç›¸åŒå‚æ•°åº”è¿”å›ç›¸åŒå†…å®¹ï¼Œéœ€è¦æ ¹æ® request body å‚æ•°ç¼“å­˜
   - å½“å‰è¡Œä¸ºï¼šåªèƒ½æ ¹æ® URL ç¼“å­˜ï¼Œæ— æ³•åŒºåˆ†ä¸åŒçš„ POST å‚æ•° âŒ

3. **ç¼ºä¹ç²¾ç»†æ§åˆ¶**
   - é—®é¢˜ï¼šæ— æ³•ä¸ºä¸åŒè·¯å¾„é…ç½®ä¸åŒçš„ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥
   - å½“å‰è¡Œä¸ºï¼šä¸€åˆ€åˆ‡çš„ç­–ç•¥ï¼Œç¼ºä¹çµæ´»æ€§ âŒ

### ä¸šåŠ¡éœ€æ±‚

æ¯ä¸ªè·¯å¾„éƒ½éœ€è¦æå¤§çš„è‡ªç”±åº¦ï¼Œèƒ½å¤Ÿé€‰æ‹©ï¼š

- **ä»… Headers**ï¼šæ ¹æ®æŒ‡å®šçš„ headerï¼ˆå¦‚ tokenã€cidï¼‰ç”Ÿæˆç¼“å­˜é”®çš„ hash
- **ä»…å‚æ•°**ï¼šæ ¹æ®å…¨éƒ¨æˆ–éƒ¨åˆ†è¯·æ±‚å‚æ•°ç”Ÿæˆç¼“å­˜é”®çš„ hash
- **Headers + å‚æ•°**ï¼šç»„åˆä½¿ç”¨ï¼Œé€‚åº”å¤æ‚åœºæ™¯

åŒæ—¶ï¼Œéœ€è¦åœ¨ç®¡ç†ç•Œé¢ä¸­ï¼š
- å±•ç¤ºæ¯ä¸ªè·¯å¾„ä½¿ç”¨çš„ç¼“å­˜ç­–ç•¥
- æŸ¥çœ‹æ¯ä¸ªè·¯å¾„ä¸‹æ‰€æœ‰ç¼“å­˜æ¡ç›®ï¼ˆæŒ‰ hash åŒºåˆ†ï¼‰
- æ˜¾ç¤ºæ¯ä¸ªç¼“å­˜æ¡ç›®çš„è¯·æ±‚æ¬¡æ•°ã€å¤§å°ã€è¿‡æœŸæ—¶é—´ç­‰

---

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

å¼•å…¥**å¯é…ç½®çš„ç¼“å­˜é”®ç­–ç•¥ç³»ç»Ÿ**ï¼Œæ”¯æŒ 4 ç§ç­–ç•¥ï¼š

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|-----|------|---------|------|
| `path-only` | ä»…æ ¹æ®è·¯å¾„ç¼“å­˜ | é™æ€å†…å®¹ã€å…¬å…±æ•°æ® | `/api/config` |
| `path-params` | è·¯å¾„ + è¯·æ±‚å‚æ•° | åˆ†é¡µåˆ—è¡¨ã€æœç´¢ç»“æœ | `/api/articles?page=1&size=10` |
| `path-headers` | è·¯å¾„ + æŒ‡å®š headers | ç”¨æˆ·ç›¸å…³æ•°æ® | `/api/user/self` (åŸºäº token) |
| `path-params-headers` | è·¯å¾„ + å‚æ•° + headers | å¤æ‚ä¸šåŠ¡åœºæ™¯ | `/api/orders?status=pending` (åŸºäº token) |

### åŠŸèƒ½ç‰¹æ€§

âœ… **è·¯å¾„çº§åˆ«é…ç½®**ï¼šæ¯ä¸ªè·¯å¾„ç‹¬ç«‹é…ç½®ç¼“å­˜ç­–ç•¥  
âœ… **Header é€‰æ‹©**ï¼šè‡ªå®šä¹‰å“ªäº› header å‚ä¸ç¼“å­˜é”®ç”Ÿæˆ  
âœ… **å‚æ•°é€‰æ‹©**ï¼šæ”¯æŒ"å…¨éƒ¨å‚æ•°"æˆ–"æŒ‡å®šå‚æ•°"  
âœ… **ç¼“å­˜æ¡ç›®ç®¡ç†**ï¼šæŸ¥çœ‹ã€ç»Ÿè®¡ã€åˆ é™¤æ¯ä¸ªè·¯å¾„ä¸‹çš„æ‰€æœ‰ç¼“å­˜æ¡ç›®  
âœ… **å‘åå…¼å®¹**ï¼šé»˜è®¤ç­–ç•¥ä¿æŒç°æœ‰è¡Œä¸º  
âœ… **æ¸è¿›å¼è¿ç§»**ï¼šä¸å½±å“ç°æœ‰é…ç½®ï¼Œé€æ­¥è¿ç§»

---

## æŠ€æœ¯è®¾è®¡

### 1. æ•°æ®æ¨¡å‹

#### ç¼“å­˜é”®ç­–ç•¥æšä¸¾

```typescript
export type CacheKeyStrategy = 
  | 'path-only'              // ä»…è·¯å¾„
  | 'path-params'            // è·¯å¾„ + å…¨éƒ¨å‚æ•°
  | 'path-headers'           // è·¯å¾„ + æŒ‡å®š headers
  | 'path-params-headers';   // è·¯å¾„ + å‚æ•° + headers
```

#### è·¯å¾„ç¼“å­˜é…ç½®æ‰©å±•

```typescript
export interface PathCacheConfig {
  enabled: boolean;
  version: number;
  ttl?: number;
  
  // æ–°å¢å­—æ®µ
  keyStrategy?: CacheKeyStrategy;       // ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥
  keyHeaders?: string[];                // å‚ä¸ç¼“å­˜é”®çš„ header åç§°åˆ—è¡¨
  keyParams?: 'all' | string[];         // 'all' æˆ–æŒ‡å®šå‚æ•°ååˆ—è¡¨
}
```

#### ç¼“å­˜æ¡ç›®å…ƒæ•°æ®

```typescript
export interface CacheEntryMetadata {
  cacheKey: string;          // å®Œæ•´çš„ç¼“å­˜é”®
  hash: string;              // hash å€¼ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
  path: string;              // è·¯å¾„
  requestCount: number;      // è¯¥ç¼“å­˜æ¡ç›®çš„è¯·æ±‚æ¬¡æ•°
  size: number;              // ç¼“å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  createdAt: number;         // åˆ›å»ºæ—¶é—´
  lastAccessed: number;      // æœ€åè®¿é—®æ—¶é—´
  ttl?: number;              // TTLé…ç½®
  expiresAt?: number;        // è¿‡æœŸæ—¶é—´
}
```

### 2. æ ¸å¿ƒç®—æ³•

#### ç¼“å­˜é”®ç”Ÿæˆç®—æ³•

```typescript
/**
 * ç”Ÿæˆç¼“å­˜é”®ï¼ˆæ”¯æŒå¤šç§ç­–ç•¥ï¼‰
 * 
 * @param path - è¯·æ±‚è·¯å¾„
 * @param options - é…ç½®é€‰é¡¹
 * @returns ç¼“å­˜é”®å­—ç¬¦ä¸²
 * 
 * ç¼“å­˜é”®æ ¼å¼: cache:v{version}:{path}:{hash}
 * å…¶ä¸­ hash ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼ˆæ ¹æ®ç­–ç•¥ï¼‰ï¼š
 * - path-only: SHA256(path)
 * - path-params: SHA256(path + JSON.stringify(params))
 * - path-headers: SHA256(path + JSON.stringify(selectedHeaders))
 * - path-params-headers: SHA256(path + 'params:' + JSON.stringify(params) + 'headers:' + JSON.stringify(headers))
 */
export async function getCacheKey(
  path: string,
  options: {
    version: number;
    strategy?: CacheKeyStrategy;
    params?: any;
    headers?: Record<string, string>;
    keyHeaders?: string[];
    keyParams?: 'all' | string[];
  }
): Promise<string>
```

**ç®—æ³•æµç¨‹**ï¼š

1. åˆå§‹åŒ– hash è¾“å…¥æ•°ç»„ï¼š`[path]`
2. æ ¹æ®ç­–ç•¥æ·»åŠ ç»„ä»¶ï¼š
   - `path-params`: æ·»åŠ å‚æ•°çš„ JSON å­—ç¬¦ä¸²
   - `path-headers`: æ·»åŠ é€‰å®š headers çš„ JSON å­—ç¬¦ä¸²
   - `path-params-headers`: åŒæ—¶æ·»åŠ å‚æ•°å’Œ headers
3. æ‹¼æ¥æ‰€æœ‰ç»„ä»¶ï¼š`hashInput = parts.join('|')`
4. è®¡ç®— SHA-256 å“ˆå¸Œå€¼
5. è¿”å›å®Œæ•´ç¼“å­˜é”®ï¼š`cache:v{version}:{path}:{hash}`

### 3. API è®¾è®¡

#### åç«¯ API

**è·å–è·¯å¾„ç¼“å­˜æ¡ç›®åˆ—è¡¨**

```http
GET /api/admin/paths/:path/cache-entries
```

å“åº”ï¼š
```json
{
  "success": true,
  "data": {
    "path": "/biz-client/biz/user/self",
    "entries": [
      {
        "cacheKey": "cache:v1:/biz-client/biz/user/self:abc123...",
        "hash": "abc123...",
        "requestCount": 156,
        "size": 2048,
        "createdAt": 1696234567890,
        "lastAccessed": 1696234987654,
        "ttl": 300,
        "expiresAt": 1696234867890
      }
    ],
    "total": 3
  },
  "timestamp": "2025-10-02T10:30:00Z"
}
```

**æ›´æ–°è·¯å¾„é…ç½®**ï¼ˆæ‰©å±•ç°æœ‰æ¥å£ï¼‰

```http
PUT /api/admin/paths
```

è¯·æ±‚ä½“ï¼š
```json
{
  "path": "/biz-client/biz/user/self",
  "config": {
    "cache": {
      "enabled": true,
      "version": 1,
      "ttl": 300,
      "keyStrategy": "path-headers",
      "keyHeaders": ["authorization", "x-user-id"]
    }
  }
}
```

### 4. å‰ç«¯ç•Œé¢è®¾è®¡

#### è·¯å¾„ç®¡ç†è¡¨æ ¼ï¼ˆæ–°å¢åˆ—ï¼‰

| è·¯å¾„ | æ–¹æ³• | ç¼“å­˜ | **ç¼“å­˜ç­–ç•¥** | **ç¼“å­˜æ¡ç›®** | é™æµ | åœ°åŸŸ | æ“ä½œ |
|-----|------|------|------------|------------|------|------|------|
| /api/user/self | GET | âœ… | **è·¯å¾„+Header**<br/><small>authorization</small> | **[3 æ¡]** | âœ… | âŒ | âš™ï¸ |
| /api/articles | GET | âœ… | **è·¯å¾„+å‚æ•°** | **[12 æ¡]** | âœ… | âŒ | âš™ï¸ |

#### é…ç½®å¯¹è¯æ¡†ï¼ˆç¼“å­˜ç­–ç•¥é€‰æ‹©ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼“å­˜é…ç½®                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜‘ å¯ç”¨ç¼“å­˜                                   â”‚
â”‚                                              â”‚
â”‚ ç‰ˆæœ¬å·: [1]        TTL: [300] ç§’             â”‚
â”‚                                              â”‚
â”‚ ç¼“å­˜é”®ç­–ç•¥:                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ è·¯å¾„ + Headers              â–¼       â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚ åŒ…å«çš„ Headers:                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ authorization, x-user-id            â”‚     â”‚
â”‚ â”‚ [+ æ·»åŠ ]                             â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚ â„¹ï¸  å½“å‰é…ç½®ï¼šæ ¹æ® authorization å’Œ x-user-id  â”‚
â”‚    header ä¸ºä¸åŒç”¨æˆ·ç”Ÿæˆç‹¬ç«‹ç¼“å­˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼“å­˜æ¡ç›®å­è¡¨æ ¼ï¼ˆæ–°ç»„ä»¶ï¼‰

ç‚¹å‡»"ç¼“å­˜æ¡ç›®"åˆ—çš„æ•°å­—ï¼Œå¼¹å‡ºå¯¹è¯æ¡†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼“å­˜æ¡ç›®è¯¦æƒ… - /biz-client/biz/user/self                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…± 3 ä¸ªç¼“å­˜æ¡ç›®                              [ğŸ”„ åˆ·æ–°]      â”‚
â”‚                                                            â”‚
â”‚ Hash              â”‚ å¤§å°   â”‚ åˆ›å»ºæ—¶é—´    â”‚ è¿‡æœŸ  â”‚ è¯·æ±‚  â”‚  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚ abc123...         â”‚ 2.0 KB â”‚ 2åˆ†é’Ÿå‰     â”‚ 3åˆ†é’Ÿ â”‚ 156  â”‚ğŸ—‘â”‚
â”‚ def456...         â”‚ 1.8 KB â”‚ 5åˆ†é’Ÿå‰     â”‚ 5ç§’   â”‚ 89   â”‚ğŸ—‘â”‚
â”‚ ghi789...         â”‚ 2.1 KB â”‚ 10åˆ†é’Ÿå‰    â”‚ å·²è¿‡æœŸâ”‚ 234  â”‚ğŸ—‘â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®æ–½è®¡åˆ’

### Phase 1: åç«¯åŸºç¡€æ¶æ„ï¼ˆ2-3å¤©ï¼‰

**æ–‡ä»¶å˜æ›´**ï¼š
- `apps/api/src/types/config.ts` - ç±»å‹å®šä¹‰
- `apps/api/src/lib/cache-manager.ts` - ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®šä¹‰ `CacheKeyStrategy` æšä¸¾
- [ ] æ‰©å±• `PathCacheConfig` æ¥å£
- [ ] å®šä¹‰ `CacheEntryMetadata` æ¥å£
- [ ] é‡æ„ `getCacheKey()` å‡½æ•°ï¼Œæ”¯æŒå¤šç§ç­–ç•¥
- [ ] å®ç° `getPathCacheEntries()` å‡½æ•°
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ‰€æœ‰ 4 ç§ç­–ç•¥éƒ½èƒ½æ­£ç¡®ç”Ÿæˆç¼“å­˜é”®
- âœ… ç›¸åŒè¾“å…¥ç”Ÿæˆç›¸åŒ hash
- âœ… ä¸åŒè¾“å…¥ç”Ÿæˆä¸åŒ hash
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 90%

### Phase 2: åç«¯ API å±‚ï¼ˆ1-2å¤©ï¼‰

**æ–‡ä»¶å˜æ›´**ï¼š
- `apps/api/src/middleware/cache.ts` - ç¼“å­˜ä¸­é—´ä»¶
- `apps/api/src/routes/admin/paths.ts` - è·¯å¾„ç®¡ç† API

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] ä¿®æ”¹ç¼“å­˜ä¸­é—´ä»¶ï¼Œè¯»å–å¹¶åº”ç”¨ç­–ç•¥é…ç½®
- [ ] å¤„ç† POST è¯·æ±‚çš„ body å‚æ•°
- [ ] æ·»åŠ  `/paths/:path/cache-entries` ç«¯ç‚¹
- [ ] æ›´æ–°ç°æœ‰é…ç½® APIï¼Œæ”¯æŒæ–°å­—æ®µ
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… ä¸­é—´ä»¶æ­£ç¡®åº”ç”¨ä¸åŒç­–ç•¥
- âœ… POST è¯·æ±‚èƒ½åŸºäº body ç¼“å­˜
- âœ… API èƒ½è¿”å›ç¼“å­˜æ¡ç›®åˆ—è¡¨
- âœ… é›†æˆæµ‹è¯•é€šè¿‡

### Phase 3: å‰ç«¯åŸºç¡€ç»„ä»¶ï¼ˆ2-3å¤©ï¼‰

**æ–‡ä»¶å˜æ›´**ï¼š
- `apps/web/src/types/api.ts` - ç±»å‹å®šä¹‰
- `apps/web/src/components/ui/multi-input.tsx` - æ–°ç»„ä»¶
- `apps/web/src/features/paths/components/cache-entries-table.tsx` - æ–°ç»„ä»¶

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åŒæ­¥åç«¯ç±»å‹åˆ°å‰ç«¯
- [ ] åˆ›å»º `MultiInput` ç»„ä»¶ï¼ˆæ”¯æŒè¾“å…¥å¤šä¸ªå€¼ï¼‰
- [ ] åˆ›å»º `CacheEntriesTable` ç»„ä»¶ï¼ˆç¼“å­˜æ¡ç›®å­è¡¨æ ¼ï¼‰
- [ ] æ·»åŠ å·¥å…·å‡½æ•°ï¼ˆ`formatBytes`, `formatDistance`ï¼‰
- [ ] ç»„ä»¶å•å…ƒæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… TypeScript ç±»å‹æ— é”™è¯¯
- âœ… `MultiInput` ç»„ä»¶åŠŸèƒ½æ­£å¸¸
- âœ… `CacheEntriesTable` èƒ½æ­£ç¡®å±•ç¤ºæ•°æ®
- âœ… ç»„ä»¶æ¸²æŸ“æµ‹è¯•é€šè¿‡

### Phase 4: å‰ç«¯ç•Œé¢é›†æˆï¼ˆ2-3å¤©ï¼‰

**æ–‡ä»¶å˜æ›´**ï¼š
- `apps/web/src/features/paths/components/unified-path-table.tsx` - è¡¨æ ¼
- `apps/web/src/features/paths/components/path-config-dialog.tsx` - é…ç½®å¯¹è¯æ¡†
- `apps/web/src/hooks/use-path-api.ts` - API hooks

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åœ¨è·¯å¾„è¡¨æ ¼ä¸­æ·»åŠ "ç¼“å­˜ç­–ç•¥"å’Œ"ç¼“å­˜æ¡ç›®"åˆ—
- [ ] åœ¨é…ç½®å¯¹è¯æ¡†ä¸­æ·»åŠ ç­–ç•¥é€‰æ‹©è¡¨å•
- [ ] é›†æˆ `CacheEntriesTable` å­è¡¨æ ¼
- [ ] æ·»åŠ  API hookï¼š`useCacheEntries`
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… è¡¨æ ¼æ­£ç¡®æ˜¾ç¤ºç­–ç•¥ä¿¡æ¯
- âœ… é…ç½®å¯¹è¯æ¡†èƒ½ä¿å­˜ç­–ç•¥é…ç½®
- âœ… ç‚¹å‡»"ç¼“å­˜æ¡ç›®"èƒ½æ‰“å¼€å­è¡¨æ ¼
- âœ… ç«¯åˆ°ç«¯æµç¨‹é¡ºç•…

### Phase 5: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆä¸åŒç­–ç•¥çš„ç¼“å­˜å‘½ä¸­ç‡ï¼‰
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆå¤§é‡ç¼“å­˜æ¡ç›®çš„æŸ¥è¯¢æ€§èƒ½ï¼‰
- [ ] è¾¹ç•Œæµ‹è¯•ï¼ˆå¼‚å¸¸æƒ…å†µå¤„ç†ï¼‰
- [ ] å‘åå…¼å®¹æ€§æµ‹è¯•
- [ ] æ–‡æ¡£å®Œå–„
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… ç¼“å­˜é”®ç”Ÿæˆæ—¶é—´ < 5ms
- âœ… æŸ¥è¯¢ 1000 ä¸ªç¼“å­˜æ¡ç›® < 500ms
- âœ… ç°æœ‰é…ç½®æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­ä½¿ç”¨
- âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

---

## æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

**ç¼“å­˜é”®ç”Ÿæˆæµ‹è¯•** (`cache-manager.test.ts`)

```typescript
describe('getCacheKey', () => {
  it('path-only ç­–ç•¥åº”åªåŸºäºè·¯å¾„ç”Ÿæˆç¼“å­˜é”®', async () => {
    const key1 = await getCacheKey('/api/test', { 
      version: 1, 
      strategy: 'path-only',
      params: { a: 1 }
    });
    const key2 = await getCacheKey('/api/test', { 
      version: 1, 
      strategy: 'path-only',
      params: { a: 2 }
    });
    expect(key1).toBe(key2); // å‚æ•°ä¸åŒä½†ç¼“å­˜é”®ç›¸åŒ
  });

  it('path-params ç­–ç•¥åº”åŸºäºè·¯å¾„å’Œå‚æ•°ç”Ÿæˆä¸åŒç¼“å­˜é”®', async () => {
    const key1 = await getCacheKey('/api/test', { 
      version: 1, 
      strategy: 'path-params',
      params: { a: 1 }
    });
    const key2 = await getCacheKey('/api/test', { 
      version: 1, 
      strategy: 'path-params',
      params: { a: 2 }
    });
    expect(key1).not.toBe(key2); // å‚æ•°ä¸åŒï¼Œç¼“å­˜é”®ä¹Ÿä¸åŒ
  });

  it('path-headers ç­–ç•¥åº”åŸºäºæŒ‡å®š header ç”Ÿæˆç¼“å­˜é”®', async () => {
    const key1 = await getCacheKey('/api/user', {
      version: 1,
      strategy: 'path-headers',
      headers: { authorization: 'token1', 'x-other': 'value' },
      keyHeaders: ['authorization']
    });
    const key2 = await getCacheKey('/api/user', {
      version: 1,
      strategy: 'path-headers',
      headers: { authorization: 'token2', 'x-other': 'value' },
      keyHeaders: ['authorization']
    });
    expect(key1).not.toBe(key2); // token ä¸åŒï¼Œç¼“å­˜é”®ä¸åŒ
  });

  it('åº”å¿½ç•¥æœªæŒ‡å®šçš„ headers', async () => {
    const key1 = await getCacheKey('/api/user', {
      version: 1,
      strategy: 'path-headers',
      headers: { authorization: 'token1', 'x-other': 'value1' },
      keyHeaders: ['authorization']
    });
    const key2 = await getCacheKey('/api/user', {
      version: 1,
      strategy: 'path-headers',
      headers: { authorization: 'token1', 'x-other': 'value2' },
      keyHeaders: ['authorization']
    });
    expect(key1).toBe(key2); // x-other æœªæŒ‡å®šï¼Œä¸å½±å“ç¼“å­˜é”®
  });
});
```

### é›†æˆæµ‹è¯•

**ç¼“å­˜ä¸­é—´ä»¶æµ‹è¯•** (`cache-middleware.test.ts`)

```typescript
describe('Cache Middleware with flexible strategies', () => {
  it('åº”æ ¹æ®é…ç½®çš„ç­–ç•¥ç”Ÿæˆç¼“å­˜é”®', async () => {
    // é…ç½®è·¯å¾„ä½¿ç”¨ path-headers ç­–ç•¥
    await updatePathConfig(env, '/api/user/self', {
      enabled: true,
      version: 1,
      keyStrategy: 'path-headers',
      keyHeaders: ['authorization']
    });

    // ç¬¬ä¸€ä¸ªç”¨æˆ·è¯·æ±‚
    const res1 = await app.request('/api/user/self', {
      headers: { authorization: 'token1' }
    });
    expect(res1.status).toBe(200);
    const data1 = await res1.json();

    // ç¬¬äºŒä¸ªç”¨æˆ·è¯·æ±‚
    const res2 = await app.request('/api/user/self', {
      headers: { authorization: 'token2' }
    });
    expect(res2.status).toBe(200);
    const data2 = await res2.json();

    // åº”è¯¥è¿”å›ä¸åŒçš„æ•°æ®ï¼ˆä¸åŒç”¨æˆ·ï¼‰
    expect(data1).not.toEqual(data2);
  });

  it('POST è¯·æ±‚åº”èƒ½åŸºäº body å‚æ•°ç¼“å­˜', async () => {
    await updatePathConfig(env, '/api/videos/list', {
      enabled: true,
      version: 1,
      keyStrategy: 'path-params',
      keyParams: 'all'
    });

    // ç¬¬ä¸€æ¬¡è¯·æ±‚
    const res1 = await app.request('/api/videos/list', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ page: 1, size: 10 })
    });
    
    // ç¬¬äºŒæ¬¡ç›¸åŒå‚æ•°è¯·æ±‚ï¼ˆåº”å‘½ä¸­ç¼“å­˜ï¼‰
    const res2 = await app.request('/api/videos/list', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ page: 1, size: 10 })
    });
    
    expect(res2.headers.get('x-cache')).toBe('HIT');
  });
});
```

### ç«¯åˆ°ç«¯æµ‹è¯•

**å‰ç«¯ç•Œé¢æµ‹è¯•**

1. **é…ç½®ç¼“å­˜ç­–ç•¥**
   - æ‰“å¼€è·¯å¾„é…ç½®å¯¹è¯æ¡†
   - é€‰æ‹©"è·¯å¾„ + Headers"ç­–ç•¥
   - æ·»åŠ  `authorization` header
   - ä¿å­˜é…ç½®
   - éªŒè¯ï¼šè¡¨æ ¼æ˜¾ç¤ºæ­£ç¡®çš„ç­–ç•¥æ ‡ç­¾

2. **æŸ¥çœ‹ç¼“å­˜æ¡ç›®**
   - ç‚¹å‡»"ç¼“å­˜æ¡ç›®"åˆ—çš„æ•°å­—
   - å¼¹å‡ºç¼“å­˜æ¡ç›®å­è¡¨æ ¼
   - éªŒè¯ï¼šæ˜¾ç¤ºæ‰€æœ‰ç¼“å­˜æ¡ç›®åŠå…¶å…ƒæ•°æ®

3. **åˆ é™¤ç¼“å­˜æ¡ç›®**
   - åœ¨ç¼“å­˜æ¡ç›®å­è¡¨æ ¼ä¸­ç‚¹å‡»åˆ é™¤æŒ‰é’®
   - ç¡®è®¤åˆ é™¤
   - éªŒè¯ï¼šæ¡ç›®ä»åˆ—è¡¨ä¸­æ¶ˆå¤±

---

## è¿ç§»æŒ‡å—

### ç°æœ‰ç³»ç»Ÿè¿ç§»

**é»˜è®¤è¡Œä¸º**ï¼š
- æœªé…ç½®ç­–ç•¥çš„è·¯å¾„è‡ªåŠ¨ä½¿ç”¨ `path-params` ç­–ç•¥
- ä¸æ—§ç‰ˆè¡Œä¸ºä¿æŒä¸€è‡´ï¼Œç¡®ä¿å‘åå…¼å®¹

**æ¨èè¿ç§»æ­¥éª¤**ï¼š

1. **è¯†åˆ«éœ€è¦è¿ç§»çš„è·¯å¾„**
   ```bash
   # æ‰¾å‡ºè¿”å›ç”¨æˆ·ç›¸å…³æ•°æ®çš„è·¯å¾„
   /api/user/self
   /api/user/profile
   /api/user/settings
   ```

2. **ä¸ºè¿™äº›è·¯å¾„é…ç½® `path-headers` ç­–ç•¥**
   - åœ¨ç®¡ç†ç•Œé¢ä¸­æ‰“å¼€è·¯å¾„é…ç½®
   - é€‰æ‹©"è·¯å¾„ + Headers"
   - æ·»åŠ  `authorization` header
   - ä¿å­˜é…ç½®

3. **åˆ·æ–°æ—§ç¼“å­˜**
   - ç‚¹å‡»"åˆ·æ–°ç¼“å­˜"æŒ‰é’®
   - æˆ–ç­‰å¾…æ—§ç¼“å­˜è‡ªç„¶è¿‡æœŸï¼ˆæ ¹æ® TTLï¼‰

4. **éªŒè¯æ–°ç­–ç•¥**
   - ä½¿ç”¨ä¸åŒç”¨æˆ· token è¯·æ±‚åŒä¸€è·¯å¾„
   - éªŒè¯è¿”å›ä¸åŒçš„æ•°æ®
   - æ£€æŸ¥ç¼“å­˜æ¡ç›®åˆ—è¡¨ï¼Œåº”æœ‰å¤šä¸ªæ¡ç›®

### é…ç½®ç¤ºä¾‹

**ç¤ºä¾‹ 1ï¼šç”¨æˆ·ä¸ªäººä¿¡æ¯æ¥å£**

```json
{
  "path": "/biz-client/biz/user/self",
  "cache": {
    "enabled": true,
    "version": 1,
    "ttl": 300,
    "keyStrategy": "path-headers",
    "keyHeaders": ["authorization"]
  }
}
```

**ç¤ºä¾‹ 2ï¼šå¸¦åˆ†é¡µçš„åˆ—è¡¨æ¥å£ï¼ˆæ ¹æ®ç”¨æˆ·ï¼‰**

```json
{
  "path": "/biz-client/biz/issueReplayVideo/list",
  "cache": {
    "enabled": true,
    "version": 1,
    "ttl": 600,
    "keyStrategy": "path-params-headers",
    "keyHeaders": ["authorization"],
    "keyParams": "all"
  }
}
```

**ç¤ºä¾‹ 3ï¼šå…¬å…±é…ç½®æ¥å£**

```json
{
  "path": "/api/config",
  "cache": {
    "enabled": true,
    "version": 1,
    "ttl": 3600,
    "keyStrategy": "path-only"
  }
}
```

---

## å›æ»šæ–¹æ¡ˆ

### ç´§æ€¥å›æ»š

å¦‚æœæ–°åŠŸèƒ½å‡ºç°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# 1. åˆ‡æ¢å› main åˆ†æ”¯
git checkout main

# 2. é‡æ–°éƒ¨ç½²
npm run deploy

# 3. éªŒè¯æœåŠ¡æ­£å¸¸
curl https://your-api.com/health
```

### é™çº§æ–¹æ¡ˆ

å¦‚æœåªæ˜¯éƒ¨åˆ†åŠŸèƒ½æœ‰é—®é¢˜ï¼Œå¯ä»¥é™çº§ï¼š

1. **ç¦ç”¨æ–°ç­–ç•¥ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º**
   - åœ¨é…ç½®ä¸­ç§»é™¤ `keyStrategy` å­—æ®µ
   - ç³»ç»Ÿè‡ªåŠ¨å›é€€åˆ° `path-params` ç­–ç•¥

2. **éšè—å‰ç«¯æ–°åŠŸèƒ½**
   - é€šè¿‡ feature flag éšè—ç­–ç•¥é€‰æ‹©å™¨
   - ä¿ç•™æ ¸å¿ƒç¼“å­˜åŠŸèƒ½

### æ•°æ®å…¼å®¹æ€§

- âœ… æ—§çš„ç¼“å­˜é”®æ ¼å¼ç»§ç»­æœ‰æ•ˆ
- âœ… æ–°æ—§ç¼“å­˜é”®å¯ä»¥å…±å­˜
- âœ… é…ç½®ä¸åŒ…å«æ–°å­—æ®µæ—¶ä½¿ç”¨é»˜è®¤ç­–ç•¥

---

## é™„å½•

### A. é…ç½®å­—æ®µå®Œæ•´è¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|------|--------|------|
| `keyStrategy` | `CacheKeyStrategy` | å¦ | `path-params` | ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥ |
| `keyHeaders` | `string[]` | å¦ | `[]` | å‚ä¸ç¼“å­˜é”®çš„ header åç§°åˆ—è¡¨ï¼ˆå°å†™ï¼‰ |
| `keyParams` | `'all' \| string[]` | å¦ | `'all'` | `'all'` è¡¨ç¤ºæ‰€æœ‰å‚æ•°ï¼Œæˆ–æŒ‡å®šå‚æ•°ååˆ—è¡¨ |

### B. æ€§èƒ½åŸºå‡†

| æ“ä½œ | ç›®æ ‡æ€§èƒ½ | å®æµ‹æ€§èƒ½ |
|-----|---------|---------|
| ç”Ÿæˆç¼“å­˜é”®ï¼ˆpath-onlyï¼‰ | < 1ms | TBD |
| ç”Ÿæˆç¼“å­˜é”®ï¼ˆpath-paramsï¼‰ | < 3ms | TBD |
| ç”Ÿæˆç¼“å­˜é”®ï¼ˆpath-headersï¼‰ | < 3ms | TBD |
| ç”Ÿæˆç¼“å­˜é”®ï¼ˆpath-params-headersï¼‰ | < 5ms | TBD |
| æŸ¥è¯¢ 100 ä¸ªç¼“å­˜æ¡ç›® | < 100ms | TBD |
| æŸ¥è¯¢ 1000 ä¸ªç¼“å­˜æ¡ç›® | < 500ms | TBD |

### C. ç›¸å…³æ–‡æ¡£

- [API å‚è€ƒæ–‡æ¡£](../API_REFERENCE.md)
- [ç¼“å­˜ç³»ç»Ÿè®¾è®¡](../APIä»£ç†ç¼“å­˜ä¼˜åŒ–æŠ€æœ¯æ–¹æ¡ˆ.md)
- [æ¶æ„æŒ‡å—](../CLAUDE.md)

---

## å˜æ›´æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| 2025-10-02 | 0.1.0 | åˆå§‹æ–‡æ¡£åˆ›å»º | Claude |

---

**åˆ†æ”¯çŠ¶æ€**: ğŸš§ å¼€å‘ä¸­  
**é¢„è®¡å®Œæˆæ—¶é—´**: 2-3 å‘¨  
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
**å®¡æ ¸äºº**: TBD

