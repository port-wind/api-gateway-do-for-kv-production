# 地区访问控制使用指南

## 📋 概述

地区访问控制功能允许您按国家/地区批量管理 API 访问权限，支持白名单和黑名单模式。

## 🎯 功能特性

### MVP 版本（当前）
- ✅ **全局规则**：应用于所有路径的地区访问控制
- ✅ **两种模式**：白名单（Allow）和黑名单（Block）
- ✅ **三种匹配方式**：
  - 按国家：支持多选常用国家
  - 按大洲：支持 6 个大洲选择
  - 预定义组：高风险地区、GDPR 国家、亚太地区等
- ✅ **优先级控制**：规则按优先级顺序执行
- ✅ **实时生效**：规则更新后 1-2 分钟内生效

## 🚀 快速开始

### 1. 访问管理页面

导航至：**地区规则** 页面（侧边栏 → 地区规则）

### 2. 创建第一条规则

点击 **"创建规则"** 按钮，填写以下信息：

#### 基本信息
- **规则名称**：规则的描述性名称（如 "阻止高风险地区"）
- **规则模式**：选择 `封禁 (Block)` 或 `放行 (Allow)`
- **优先级**：数字越小越优先（建议从 100 开始）

#### 地区匹配
选择以下三种方式之一：

**方式 1：按国家**
```
示例：封禁朝鲜和伊拉克
1. 选择 "按国家" 标签页
2. 在下拉框中选择 "🇰🇵 朝鲜"、"🇮🇶 伊拉克"
3. 支持搜索和多选
```

**方式 2：按大洲**
```
示例：仅允许亚洲访问
1. 选择 "按大洲" 标签页
2. 勾选 "🌏 亚洲 (Asia)"
3. 规则模式选择 "放行 (Allow)"
4. 默认动作设为 "封禁"
```

**方式 3：预定义组**
```
示例：封禁高风险地区
1. 选择 "预定义组" 标签页
2. 选择 "high-risk（高风险地区）"
3. 该组包含 8 个高风险国家
```

#### 可选配置
- **自定义响应消息**：覆盖默认的 "Access denied from your region"
- **备注说明**：记录规则创建原因

### 3. 管理规则

#### 启用/禁用规则
- 使用表格中的开关按钮快速切换规则状态
- 禁用后规则不会被执行

#### 调整优先级
- 规则按优先级（数字越小越优先）顺序执行
- 编辑规则修改优先级数字

#### 删除规则
- 点击表格中的删除按钮
- 确认后规则将永久删除

## 📊 规则执行逻辑

### 执行顺序
```
1. 身份认证
2. IP 封禁/限流（优先于地区规则）
3. 地区访问控制 ⬅️ 当前功能
4. 路径级限流
5. 缓存中间件
6. 业务逻辑
```

### 匹配规则
1. 按优先级排序（0 > 1 > 2 > ...）
2. 匹配到第一条规则后立即执行
3. 如果所有规则都不匹配，执行默认动作（默认为 `放行`）

### 示例场景

**场景 1：仅允许特定国家访问**
```json
{
  "defaultAction": "block",
  "rules": [
    {
      "priority": 1,
      "mode": "allow",
      "geoMatch": {
        "type": "country",
        "countries": ["US", "GB", "JP"]
      }
    }
  ]
}
```
✅ 结果：仅允许美国、英国、日本访问，其他地区全部封禁

**场景 2：封禁高风险地区**
```json
{
  "defaultAction": "allow",
  "rules": [
    {
      "priority": 1,
      "mode": "block",
      "geoMatch": {
        "type": "custom",
        "customGroups": ["high-risk"]
      }
    }
  ]
}
```
✅ 结果：封禁高风险地区（8 个国家），其他地区全部放行

**场景 3：多规则组合**
```json
{
  "defaultAction": "allow",
  "rules": [
    {
      "priority": 1,
      "mode": "block",
      "geoMatch": {
        "type": "country",
        "countries": ["KP", "IQ"]
      }
    },
    {
      "priority": 2,
      "mode": "allow",
      "geoMatch": {
        "type": "continent",
        "continents": ["AS"]
      }
    }
  ]
}
```
✅ 结果：
- 朝鲜、伊拉克 → 封禁（优先级 1）
- 其他亚洲国家 → 放行（优先级 2）
- 非亚洲国家 → 放行（默认动作）

## ⚠️ 注意事项

### 规则冲突
- ❌ **避免同一地区在多条规则中出现**
- 示例：规则 1 封禁中国，规则 2 放行亚洲 → 中国会被封禁（优先级更高）

### 性能优化
- ✅ **规则集缓存 10 分钟**：减少 KV 读取
- ✅ **短路执行**：匹配到第一条规则后立即返回
- ✅ **建议规则数量 < 50 条**：过多规则可能影响性能

### 地理位置准确性
- ⚠️ **Cloudflare `cf.country` 可能不准确**（VPN/代理）
- ✅ **建议结合 IP 封禁使用**：恶意 IP 直接封禁
- ✅ **仅用于辅助决策**：不用于绝对安全控制

### 测试建议
- ✅ **先在测试环境验证**：避免误封正常用户
- ✅ **逐步放开**：从严格规则开始，逐步放宽
- ✅ **监控流量**：观察封禁率和错误率

## 🔧 故障排查

### 问题 1：规则不生效
**原因**：规则缓存未更新（10 分钟 TTL）

**解决方案**：
1. 等待 1-2 分钟
2. 刷新页面确认规则已保存
3. 如果仍不生效，检查规则优先级和匹配条件

### 问题 2：误封正常用户
**原因**：规则配置过于宽泛

**解决方案**：
1. 立即禁用问题规则（使用开关按钮）
2. 调整规则匹配条件
3. 重新启用并监控

### 问题 3：地理位置不准确
**原因**：VPN/代理用户

**解决方案**：
1. 结合 IP 封禁使用
2. 不要将地区规则作为唯一安全手段
3. 考虑添加更细粒度的验证机制

## 📈 后续功能（Phase 2+）

- ⏸️ **路径级规则**：为特定路径配置地区规则
- ⏸️ **限流模式**：地区级流量限制
- ⏸️ **自定义地区组**：创建自己的地区组合
- ⏸️ **地区流量统计**：查看各地区的流量趋势
- ⏸️ **地区热力图**：可视化全球流量分布

## 📞 技术支持

如有问题，请联系技术团队或查阅完整技术方案文档：
- 技术方案：`docs/geo-access-control.plan.md`
- API 文档：`/docs` 页面

