# çµæ´»ç¼“å­˜é”®ç­–ç•¥ - å¿«é€Ÿå¯¼èˆª

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

ä¸º API Gateway å¼•å…¥å¯é…ç½®çš„ç¼“å­˜é”®ç­–ç•¥ç³»ç»Ÿï¼Œæ”¯æŒåŸºäº headersã€å‚æ•°æˆ–ä¸¤è€…ç»„åˆçš„çµæ´»ç¼“å­˜ç­–ç•¥ã€‚

**å¼€å‘åˆ†æ”¯**: `feature/flexible-cache-key-strategy`

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### æ ¸å¿ƒæ–‡æ¡£

| æ–‡æ¡£ | æè¿° | é˜…è¯»å¯¹è±¡ |
|-----|------|---------|
| [åŠŸèƒ½è®¾è®¡æ–‡æ¡£](./flexible-cache-key-strategy.md) | å®Œæ•´çš„æŠ€æœ¯è®¾è®¡ã€å®æ–½æ–¹æ¡ˆã€æµ‹è¯•è®¡åˆ’ | å¼€å‘äººå‘˜ |
| [å¼€å‘æ—¥å¿—](./DEVELOPMENT_LOG.md) | å¼€å‘è¿›åº¦è¿½è¸ªã€å†³ç­–è®°å½• | å…¨ä½“æˆå‘˜ |
| [CHANGELOG](../CHANGELOG.md) | åŠŸèƒ½å˜æ›´é¢„å‘Š | å…¨ä½“æˆå‘˜ |

### ç›¸å…³æ–‡æ¡£

- [API å‚è€ƒæ–‡æ¡£](../API_REFERENCE.md) - API ç«¯ç‚¹è¯¦ç»†è¯´æ˜
- [ç¼“å­˜æŠ€æœ¯æ–¹æ¡ˆ](../APIä»£ç†ç¼“å­˜ä¼˜åŒ–æŠ€æœ¯æ–¹æ¡ˆ.md) - ç¼“å­˜ç³»ç»Ÿæ•´ä½“è®¾è®¡
- [å¼€å‘è§„èŒƒ](../CLAUDE.md) - é¡¹ç›®å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ‡æ¢åˆ°å¼€å‘åˆ†æ”¯

```bash
git checkout feature/flexible-cache-key-strategy
```

### 2. äº†è§£æ ¸å¿ƒæ¦‚å¿µ

**4 ç§ç¼“å­˜é”®ç­–ç•¥**ï¼š

```typescript
// 1. path-only: æ‰€æœ‰ç”¨æˆ·å…±äº«ç¼“å­˜
cache:v1:/api/config:{hash_of_path}

// 2. path-params: æ ¹æ®å‚æ•°åŒºåˆ†ç¼“å­˜
cache:v1:/api/articles:{hash_of_path_and_params}

// 3. path-headers: æ ¹æ®æŒ‡å®š header åŒºåˆ†ç¼“å­˜ï¼ˆç”¨æˆ·éš”ç¦»ï¼‰
cache:v1:/api/user/self:{hash_of_path_and_selected_headers}

// 4. path-params-headers: ç»„åˆç­–ç•¥
cache:v1:/api/orders:{hash_of_path_params_and_headers}
```

### 3. é…ç½®ç¤ºä¾‹

**ç”¨æˆ·ä¸ªäººä¿¡æ¯æ¥å£**ï¼ˆåŸºäº token ç¼“å­˜ï¼‰ï¼š

```json
{
  "path": "/biz-client/biz/user/self",
  "cache": {
    "enabled": true,
    "version": 1,
    "ttl": 300,
    "keyStrategy": "path-headers",
    "keyHeaders": ["authorization"]
  }
}
```

**å¸¦å‚æ•°çš„åˆ—è¡¨æ¥å£**ï¼ˆåŸºäº token å’Œå‚æ•°ç¼“å­˜ï¼‰ï¼š

```json
{
  "path": "/biz-client/biz/issueReplayVideo/list",
  "cache": {
    "enabled": true,
    "version": 1,
    "ttl": 600,
    "keyStrategy": "path-params-headers",
    "keyHeaders": ["authorization"],
    "keyParams": "all"
  }
}
```

## ğŸ“‹ å¼€å‘ä»»åŠ¡è¿½è¸ª

### Phase 1: åç«¯åŸºç¡€æ¶æ„ (2-3å¤©)
- [ ] ç±»å‹å®šä¹‰å’Œæ¥å£è®¾è®¡
- [ ] ç¼“å­˜é”®ç”Ÿæˆç®—æ³•å®ç°
- [ ] å•å…ƒæµ‹è¯•

### Phase 2: åç«¯ API å±‚ (1-2å¤©)
- [ ] ç¼“å­˜ä¸­é—´ä»¶æ›´æ–°
- [ ] æ–°å¢ API ç«¯ç‚¹
- [ ] é›†æˆæµ‹è¯•

### Phase 3: å‰ç«¯åŸºç¡€ç»„ä»¶ (2-3å¤©)
- [ ] ç±»å‹åŒæ­¥
- [ ] åŸºç¡€ç»„ä»¶å¼€å‘
- [ ] ç»„ä»¶æµ‹è¯•

### Phase 4: å‰ç«¯ç•Œé¢é›†æˆ (2-3å¤©)
- [ ] è¡¨æ ¼ç•Œé¢æ›´æ–°
- [ ] é…ç½®å¯¹è¯æ¡†å¢å¼º
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

### Phase 5: æµ‹è¯•ä¸ä¼˜åŒ– (2-3å¤©)
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] å‘åå…¼å®¹æ€§æµ‹è¯•
- [ ] æ–‡æ¡£å®Œå–„

## ğŸ” å…³é”®æ–‡ä»¶æ¸…å•

### åç«¯æ ¸å¿ƒæ–‡ä»¶

```
apps/api/src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ config.ts                    # âš¡ ç±»å‹å®šä¹‰ï¼ˆæ–°å¢ç­–ç•¥æšä¸¾ï¼‰
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ cache-manager.ts             # âš¡ ç¼“å­˜ç®¡ç†ï¼ˆé‡æ„ getCacheKeyï¼‰
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ cache.ts                     # âš¡ ç¼“å­˜ä¸­é—´ä»¶ï¼ˆåº”ç”¨ç­–ç•¥ï¼‰
â””â”€â”€ routes/admin/
    â””â”€â”€ paths.ts                     # âš¡ è·¯å¾„ç®¡ç† APIï¼ˆæ–°å¢ç«¯ç‚¹ï¼‰
```

### å‰ç«¯æ ¸å¿ƒæ–‡ä»¶

```
apps/web/src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ api.ts                       # âš¡ ç±»å‹å®šä¹‰ï¼ˆåŒæ­¥åç«¯ï¼‰
â”œâ”€â”€ components/ui/
â”‚   â””â”€â”€ multi-input.tsx              # âœ¨ æ–°ç»„ä»¶ï¼ˆè¾“å…¥å¤šä¸ªå€¼ï¼‰
â””â”€â”€ features/paths/components/
    â”œâ”€â”€ unified-path-table.tsx       # âš¡ è·¯å¾„è¡¨æ ¼ï¼ˆæ–°å¢åˆ—ï¼‰
    â”œâ”€â”€ path-config-dialog.tsx       # âš¡ é…ç½®å¯¹è¯æ¡†ï¼ˆç­–ç•¥é€‰æ‹©ï¼‰
    â””â”€â”€ cache-entries-table.tsx      # âœ¨ æ–°ç»„ä»¶ï¼ˆç¼“å­˜æ¡ç›®å­è¡¨æ ¼ï¼‰
```

**å›¾ä¾‹**: âš¡ éœ€è¦ä¿®æ”¹ | âœ¨ æ–°å»ºæ–‡ä»¶

## ğŸ§ª æµ‹è¯•æŒ‡å—

### è¿è¡Œæµ‹è¯•

```bash
# åç«¯å•å…ƒæµ‹è¯•
cd apps/api
npm test

# åç«¯é›†æˆæµ‹è¯•
npm run test:integration

# å‰ç«¯ç»„ä»¶æµ‹è¯•
cd apps/web
npm test

# ç«¯åˆ°ç«¯æµ‹è¯•
npm run test:e2e
```

### æ‰‹åŠ¨æµ‹è¯•åœºæ™¯

1. **ç”¨æˆ·éš”ç¦»æµ‹è¯•**
   - é…ç½® `/api/user/self` ä½¿ç”¨ `path-headers` ç­–ç•¥
   - ä½¿ç”¨ä¸åŒ token è¯·æ±‚
   - éªŒè¯è¿”å›ä¸åŒæ•°æ®

2. **POST å‚æ•°ç¼“å­˜æµ‹è¯•**
   - é…ç½® `/api/videos/list` ä½¿ç”¨ `path-params` ç­–ç•¥
   - å‘é€ç›¸åŒå‚æ•°çš„ POST è¯·æ±‚
   - éªŒè¯ç¬¬äºŒæ¬¡è¯·æ±‚å‘½ä¸­ç¼“å­˜

3. **ç¼“å­˜æ¡ç›®æŸ¥çœ‹æµ‹è¯•**
   - ç”Ÿæˆå¤šä¸ªä¸åŒçš„ç¼“å­˜æ¡ç›®
   - æ‰“å¼€ç¼“å­˜æ¡ç›®å­è¡¨æ ¼
   - éªŒè¯æ˜¾ç¤ºæ‰€æœ‰æ¡ç›®åŠå…ƒæ•°æ®

## ğŸ“Š æ€§èƒ½åŸºå‡†

| æ“ä½œ | ç›®æ ‡ | å½“å‰ | çŠ¶æ€ |
|-----|------|------|------|
| ç”Ÿæˆç¼“å­˜é”® (path-only) | < 1ms | TBD | ğŸ”„ |
| ç”Ÿæˆç¼“å­˜é”® (path-params) | < 3ms | TBD | ğŸ”„ |
| ç”Ÿæˆç¼“å­˜é”® (path-headers) | < 3ms | TBD | ğŸ”„ |
| ç”Ÿæˆç¼“å­˜é”® (path-params-headers) | < 5ms | TBD | ğŸ”„ |
| æŸ¥è¯¢ 100 ä¸ªç¼“å­˜æ¡ç›® | < 100ms | TBD | ğŸ”„ |
| æŸ¥è¯¢ 1000 ä¸ªç¼“å­˜æ¡ç›® | < 500ms | TBD | ğŸ”„ |

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•é€‰æ‹©åˆé€‚çš„ç¼“å­˜ç­–ç•¥ï¼Ÿ

**ç­”**: æ ¹æ®æ¥å£ç‰¹æ€§é€‰æ‹©ï¼š

| æ¥å£ç±»å‹ | æ¨èç­–ç•¥ | ç¤ºä¾‹ |
|---------|---------|------|
| å…¬å…±é…ç½® | `path-only` | `/api/config` |
| åˆ—è¡¨æŸ¥è¯¢ | `path-params` | `/api/articles?page=1` |
| ç”¨æˆ·æ•°æ® | `path-headers` | `/api/user/profile` |
| ç”¨æˆ·æŸ¥è¯¢ | `path-params-headers` | `/api/orders?status=pending` |

### Q2: ä¿®æ”¹ç­–ç•¥åéœ€è¦æ¸…ç†æ—§ç¼“å­˜å—ï¼Ÿ

**ç­”**: å»ºè®®æ¸…ç†ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š
1. æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ï¼ˆé…ç½®å¯¹è¯æ¡†ä¸­ç‚¹å‡»"åˆ·æ–°ç¼“å­˜"ï¼‰
2. ç­‰å¾…æ—§ç¼“å­˜è‡ªç„¶è¿‡æœŸï¼ˆæ ¹æ® TTLï¼‰

### Q3: ç¼“å­˜é”®ä¸­çš„ header åŒºåˆ†å¤§å°å†™å—ï¼Ÿ

**ç­”**: ä¸åŒºåˆ†ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ‰€æœ‰ header åç§°è½¬ä¸ºå°å†™å¤„ç†ã€‚

### Q4: å¯ä»¥æŒ‡å®šéƒ¨åˆ†å‚æ•°å‚ä¸ç¼“å­˜é”®å—ï¼Ÿ

**ç­”**: å¯ä»¥ã€‚`keyParams` æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
- `"all"`: æ‰€æœ‰å‚æ•°
- `["param1", "param2"]`: æŒ‡å®šå‚æ•°åˆ—è¡¨

### Q5: æ—§é…ç½®éœ€è¦è¿ç§»å—ï¼Ÿ

**ç­”**: ä¸éœ€è¦ã€‚æœªé…ç½®ç­–ç•¥çš„è·¯å¾„è‡ªåŠ¨ä½¿ç”¨é»˜è®¤ç­–ç•¥ï¼ˆ`path-params`ï¼‰ï¼Œä¸æ—§è¡Œä¸ºä¸€è‡´ã€‚

## ğŸ”— ç›¸å…³èµ„æº

### å†…éƒ¨èµ„æº
- [é¡¹ç›®çœ‹æ¿](https://github.com/your-org/api-gateway/projects)
- [å›¢é˜Ÿæ–‡æ¡£](https://wiki.your-company.com/api-gateway)

### å¤–éƒ¨å‚è€ƒ
- [Cloudflare Workers Cache API](https://developers.cloudflare.com/workers/runtime-apis/cache/)
- [HTTP Caching Best Practices](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching)
- [Cache Key Design Patterns](https://aws.amazon.com/caching/best-practices/)

## ğŸ‘¥ å›¢é˜Ÿåä½œ

### è´Ÿè´£äºº
- **åç«¯å¼€å‘**: TBD
- **å‰ç«¯å¼€å‘**: TBD
- **æµ‹è¯•**: TBD
- **æ–‡æ¡£**: TBD

### æ²Ÿé€šæ¸ é“
- **æŠ€æœ¯è®¨è®º**: Slack #api-gateway-dev
- **Bug æŠ¥å‘Š**: GitHub Issues
- **ä»£ç å®¡æŸ¥**: Pull Requests

### ä¼šè®®å®‰æ’
- **æ¯æ—¥ç«™ä¼š**: 9:30 AM (15åˆ†é’Ÿ)
- **å‘¨æŠ¥**: æ¯å‘¨äº” 3:00 PM
- **Code Review**: æäº¤ PR å 24 å°æ—¶å†…

## ğŸ“ æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | å†…å®¹ | ä½œè€… |
|-----|------|------|
| 2025-10-02 | åˆ›å»ºåˆå§‹æ–‡æ¡£ | Claude |

---

**å½“å‰çŠ¶æ€**: ğŸš§ å¼€å‘å‡†å¤‡ä¸­  
**ä¸‹ä¸€æ­¥**: å¼€å§‹ Phase 1 å¼€å‘  
**æ›´æ–°æ—¶é—´**: 2025-10-02

