# ğŸš€ ä»£ç†æ€§èƒ½å¯¹æ¯”æµ‹è¯•å·¥å…·

æœ¬ç›®å½•åŒ…å«ç”¨äºæµ‹è¯• API Gateway ä»£ç†æ€§èƒ½çš„å·¥å…·ï¼Œå¸®åŠ©è¯†åˆ«æ€§èƒ½ç“¶é¢ˆå¹¶ä¼˜åŒ–ç³»ç»Ÿã€‚

## ğŸ“‹ å·¥å…·åˆ—è¡¨

### 1. quick-proxy-benchmark.sh (å¿«é€Ÿæµ‹è¯•)
åŸºäº `curl` çš„å¿«é€Ÿæ€§èƒ½æµ‹è¯•è„šæœ¬ï¼Œé€‚åˆå¿«é€ŸéªŒè¯å’Œæ—¥å¸¸ç›‘æ§ã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… æ— éœ€ä¾èµ–ï¼Œç›´æ¥è¿è¡Œ
- âœ… å¿«é€Ÿæ‰§è¡Œï¼ˆæ¯ä¸ªåœºæ™¯ 10 æ¬¡è¯·æ±‚ï¼‰
- âœ… æ¸…æ™°çš„å¯¹æ¯”æŠ¥å‘Š
- âœ… å®æ—¶æ˜¾ç¤ºè¿›åº¦

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
cd apps/api

# ä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œ
./scripts/quick-proxy-benchmark.sh

# ä¿®æ”¹æµ‹è¯•æ¬¡æ•°ï¼ˆç¼–è¾‘è„šæœ¬ä¸­çš„ TEST_COUNT å˜é‡ï¼‰
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   ğŸš€ API ä»£ç†å¿«é€Ÿæ€§èƒ½æµ‹è¯•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æµ‹è¯•é…ç½®:
  - ä»£ç†åœ°å€: https://api-proxy.pwtk.cc/...
  - ç›´è¿åœ°å€: https://biz-client.pwtk.cc/...
  - æµ‹è¯•æ¬¡æ•°: 10

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š æµ‹è¯•: ä»£ç†è·¯å¾„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š ç»Ÿè®¡ç»“æœ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DNS è§£æ:        0.0234 ç§’
  TCP è¿æ¥:        0.0892 ç§’
  TLS æ¡æ‰‹:        0.1567 ç§’
  é¦–å­—èŠ‚æ—¶é—´:      0.2891 ç§’
  æ€»æ—¶é—´:          0.3124 ç§’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ” å¯¹æ¯”åˆ†æ
  æ€»æ—¶é—´:          0.3124ç§’ vs 0.2456ç§’ (å·®: +0.0668ç§’, +27.2%)

ğŸ’¡ ç“¶é¢ˆåˆ†æ:
  âš ï¸  Worker å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®:
     - ä½¿ç”¨ wrangler tail åˆ†æè¯¦ç»†è€—æ—¶
     - æ£€æŸ¥ D1 æŸ¥è¯¢æ€§èƒ½ï¼Œæ·»åŠ å¿…è¦ç´¢å¼•
```

### 2. benchmark-proxy-vs-direct.js (è¯¦ç»†æµ‹è¯•)
åŸºäº Node.js çš„è¯¦ç»†æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œæä¾›å®Œæ•´çš„ç»Ÿè®¡åˆ†æå’Œæ€§èƒ½æ´å¯Ÿã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡ï¼ˆP50/P75/P90/P95/P99ï¼‰
- âœ… å¹¶å‘æµ‹è¯•æ”¯æŒ
- âœ… æ™ºèƒ½ç“¶é¢ˆåˆ†æ
- âœ… ä¸“ä¸šçš„ä¼˜åŒ–å»ºè®®
- âœ… å¯ç¼–ç¨‹æ¥å£

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
cd apps/api

# è¿è¡Œå®Œæ•´æµ‹è¯•
node scripts/benchmark-proxy-vs-direct.js

# æˆ–ä½¿ç”¨å¯æ‰§è¡Œæ–‡ä»¶
./scripts/benchmark-proxy-vs-direct.js
```

**é…ç½®é¡¹ï¼š**
åœ¨è„šæœ¬ä¸­ä¿®æ”¹ `config` å¯¹è±¡ï¼š
```javascript
const config = {
  warmupRequests: 5,      // é¢„çƒ­è¯·æ±‚æ•°
  testRequests: 50,       // æ­£å¼æµ‹è¯•è¯·æ±‚æ•°
  concurrency: 5,         // å¹¶å‘æ•°
  proxyUrl: '...',        // ä»£ç†åœ°å€
  directUrl: '...',       // ç›´è¿åœ°å€
  // ...
};
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                ğŸš€ API ä»£ç†æ€§èƒ½å¯¹æ¯”æµ‹è¯•å·¥å…·                         â•‘
â•‘                                                                   â•‘
â•‘  æµ‹è¯•é…ç½®:                                                        â•‘
â•‘    - é¢„çƒ­è¯·æ±‚: 5 æ¬¡                                               â•‘
â•‘    - æµ‹è¯•è¯·æ±‚: 50 æ¬¡                                              â•‘
â•‘    - å¹¶å‘æ•°: 5                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š ä»£ç†è·¯å¾„æµ‹è¯•ç»“æœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… æˆåŠŸç‡: 100.00%
âŒ å¤±è´¥æ•°: 0
ğŸ“¦ å¹³å‡å“åº”å¤§å°: 1.23 KB

â±ï¸  æ€§èƒ½æŒ‡æ ‡ (å•ä½: ms):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æŒ‡æ ‡                      æœ€å°å€¼        P50        P95        P99     æœ€å¤§å€¼       å¹³å‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DNS æŸ¥è¯¢                 12.00ms    15.00ms    23.00ms    28.00ms    31.00ms    16.50ms
TCP è¿æ¥                 45.00ms    52.00ms    67.00ms    78.00ms    85.00ms    54.30ms
TLS æ¡æ‰‹                 89.00ms    98.00ms   115.00ms   128.00ms   142.00ms   101.20ms
é¦–å­—èŠ‚æ—¶é—´ (TTFB)       234.00ms   267.00ms   312.00ms   345.00ms   378.00ms   272.40ms
å†…å®¹ä¼ è¾“                 12.00ms    18.00ms    28.00ms    35.00ms    42.00ms    19.80ms
æ€»æ—¶é—´                  256.00ms   289.00ms   334.00ms   367.00ms   398.00ms   293.60ms

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” ä»£ç† vs ç›´è¿å¯¹æ¯”åˆ†æ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â±ï¸  æ€»å“åº”æ—¶é—´å¯¹æ¯”:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æŒ‡æ ‡                        ä»£ç†        ç›´è¿        å·®å€¼      å¢åŠ æ¯”ä¾‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
P50                    289.00ms    234.00ms    55.00ms       23.50%
P95                    334.00ms    267.00ms    67.00ms       25.09%
P99                    367.00ms    298.00ms    69.00ms       23.15%
MEAN                   293.60ms    241.20ms    52.40ms       21.72%

ğŸ¯ ç“¶é¢ˆåˆ†æ:

ä»£ç†è·¯å¾„è€—æ—¶åˆ†è§£ (å¹³å‡):
  DNS æŸ¥è¯¢:        16.50ms
  TCP è¿æ¥:        37.80ms
  TLS æ¡æ‰‹:        47.10ms
  å¤„ç†æ—¶é—´:        171.00ms  <-- ä¸»è¦ç“¶é¢ˆ
  å†…å®¹ä¼ è¾“:        19.80ms

ç›´è¿è·¯å¾„è€—æ—¶åˆ†è§£ (å¹³å‡):
  DNS æŸ¥è¯¢:        14.20ms
  TCP è¿æ¥:        36.50ms
  TLS æ¡æ‰‹:        45.80ms
  å¤„ç†æ—¶é—´:        144.70ms
  å†…å®¹ä¼ è¾“:        18.50ms

ğŸ’¡ ä¸»è¦ç“¶é¢ˆ: Worker å¤„ç† + æºç«™å“åº” (å·®å¼‚: 26.30ms)

ğŸ“ ä¼˜åŒ–å»ºè®®:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸  Worker å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®:
   - æ£€æŸ¥ Worker å†…éƒ¨é€»è¾‘ï¼Œå‡å°‘ä¸å¿…è¦çš„è®¡ç®—
   - ä¼˜åŒ– D1 æŸ¥è¯¢ï¼Œæ·»åŠ ç´¢å¼•æˆ–ä½¿ç”¨é¢„èšåˆ
   - è€ƒè™‘ä½¿ç”¨ KV ç¼“å­˜çƒ­ç‚¹æ•°æ®
   - ä½¿ç”¨ wrangler tail åˆ†æè¯¦ç»†è€—æ—¶

âš ï¸ æ€§èƒ½å¯æ¥å—ï¼Œä»£ç†å¢åŠ  52.40ms å»¶è¿Ÿ (21.7%)
```

### 3. benchmark-dashboard.js (Dashboard ä¸“é¡¹æµ‹è¯•)
ä¸“é—¨ç”¨äºæµ‹è¯• Dashboard API æ€§èƒ½çš„å·¥å…·ã€‚

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
cd apps/api
node scripts/benchmark-dashboard.js
```

## ğŸ¯ æµ‹è¯•åœºæ™¯ä¸ç­–ç•¥

### åœºæ™¯ 1: å¿«é€Ÿå¥åº·æ£€æŸ¥
**ç›®çš„ï¼š** æ—¥å¸¸ç›‘æ§ï¼Œç¡®ä¿ä»£ç†æ€§èƒ½æ­£å¸¸

```bash
./scripts/quick-proxy-benchmark.sh
```

**é¢„æœŸç»“æœï¼š**
- ä»£ç†å¢åŠ å»¶è¿Ÿ < 50msï¼šä¼˜ç§€
- ä»£ç†å¢åŠ å»¶è¿Ÿ 50-150msï¼šè‰¯å¥½
- ä»£ç†å¢åŠ å»¶è¿Ÿ > 150msï¼šéœ€è¦ä¼˜åŒ–

### åœºæ™¯ 2: è¯¦ç»†æ€§èƒ½åˆ†æ
**ç›®çš„ï¼š** æ·±å…¥åˆ†ææ€§èƒ½ç“¶é¢ˆï¼Œåˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ

```bash
node scripts/benchmark-proxy-vs-direct.js
```

**å…³æ³¨æŒ‡æ ‡ï¼š**
- **P95 å»¶è¿Ÿ**ï¼š95% ç”¨æˆ·çš„ä½“éªŒ
- **P99 å»¶è¿Ÿ**ï¼šæç«¯æƒ…å†µ
- **å¤„ç†æ—¶é—´**ï¼šWorker + D1 + ä¸šåŠ¡é€»è¾‘
- **ç½‘ç»œæ—¶é—´**ï¼šDNS + TCP + TLS

### åœºæ™¯ 3: å‹åŠ›æµ‹è¯•
**ç›®çš„ï¼š** æµ‹è¯•é«˜å¹¶å‘ä¸‹çš„æ€§èƒ½è¡¨ç°

```bash
# ä¿®æ”¹ benchmark-proxy-vs-direct.js ä¸­çš„é…ç½®
# testRequests: 200
# concurrency: 20

node scripts/benchmark-proxy-vs-direct.js
```

### åœºæ™¯ 4: å®šç‚¹æµ‹é€Ÿï¼ˆè¯†åˆ«å…·ä½“ç“¶é¢ˆï¼‰

#### 4.1 ç›´æ¥æµ‹è¯•æºç«™ï¼ˆå»ºç«‹åŸºçº¿ï¼‰
```bash
curl -w "\næ—¶é—´è¯¦æƒ…:\n  DNSè§£æ: %{time_namelookup}s\n  TCPè¿æ¥: %{time_connect}s\n  TLSæ¡æ‰‹: %{time_appconnect}s\n  é¦–å­—èŠ‚: %{time_starttransfer}s\n  æ€»æ—¶é—´: %{time_total}s\n" \
  -X POST https://biz-client.pwtk.cc/biz/relationship/batch-get \
  -H 'Content-Type: application/json' \
  --data-raw '{"targetUserIdList":["1419717728603737560"],"direct":1}' \
  -o /dev/null -s
```

#### 4.2 æµ‹è¯•ä»£ç†å…¥å£
```bash
curl -w "\næ—¶é—´è¯¦æƒ…:\n  DNSè§£æ: %{time_namelookup}s\n  TCPè¿æ¥: %{time_connect}s\n  TLSæ¡æ‰‹: %{time_appconnect}s\n  é¦–å­—èŠ‚: %{time_starttransfer}s\n  æ€»æ—¶é—´: %{time_total}s\n" \
  -X POST https://api-proxy.pwtk.cc/biz-client/biz/relationship/batch-get \
  -H 'Content-Type: application/json' \
  --data-raw '{"targetUserIdList":["1419717728603737560"],"direct":1}' \
  -o /dev/null -s
```

#### 4.3 åˆ†æ Worker å†…éƒ¨è€—æ—¶
```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œ
wrangler tail --format pretty

# ç„¶ååœ¨ä¸»ç»ˆç«¯å‘é€è¯·æ±‚
curl -X POST https://api-proxy.pwtk.cc/biz-client/biz/relationship/batch-get \
  -H 'Content-Type: application/json' \
  --data-raw '{"targetUserIdList":["1419717728603737560"],"direct":1}'
```

## ğŸ” æ€§èƒ½æŒ‡æ ‡è§£è¯»

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | ç›®æ ‡å€¼ |
|------|------|--------|
| **DNS æŸ¥è¯¢** | åŸŸåè§£ææ—¶é—´ | < 30ms |
| **TCP è¿æ¥** | å»ºç«‹ TCP è¿æ¥ | < 50ms |
| **TLS æ¡æ‰‹** | SSL/TLS åå•† | < 100ms |
| **é¦–å­—èŠ‚æ—¶é—´ (TTFB)** | å¼€å§‹æ¥æ”¶æ•°æ® | < 300ms |
| **å†…å®¹ä¼ è¾“** | ä¸‹è½½å“åº”ä½“ | < 50ms |
| **æ€»æ—¶é—´** | å®Œæ•´è¯·æ±‚å‘¨æœŸ | < 400ms |

### å¤„ç†æ—¶é—´è®¡ç®—

```
å¤„ç†æ—¶é—´ = TTFB - DNSæŸ¥è¯¢ - (TCPè¿æ¥ - DNSæŸ¥è¯¢) - (TLSæ¡æ‰‹ - TCPè¿æ¥)
         = TTFB - TLSæ¡æ‰‹æ—¶é—´ç‚¹
```

å¤„ç†æ—¶é—´åŒ…æ‹¬ï¼š
1. Worker å†…éƒ¨é€»è¾‘æ‰§è¡Œ
2. D1 æ•°æ®åº“æŸ¥è¯¢
3. æºç«™ API è°ƒç”¨
4. æ•°æ®è½¬æ¢å’Œå¤„ç†

## ğŸ› ï¸ å¸¸è§ç“¶é¢ˆä¸ä¼˜åŒ–

### ç“¶é¢ˆ 1: Worker å¤„ç†æ—¶é—´è¿‡é•¿
**ç—‡çŠ¶ï¼š** å¤„ç†æ—¶é—´ > 150ms

**åŸå› ï¼š**
- D1 æŸ¥è¯¢æ…¢ï¼ˆç¼ºå°‘ç´¢å¼•ã€å…¨è¡¨æ‰«æï¼‰
- å¤æ‚çš„æ•°æ®å¤„ç†é€»è¾‘
- åŒæ­¥ç­‰å¾…å¤–éƒ¨ API

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```typescript
// âŒ ä¸å¥½ï¼šé¡ºåºæ‰§è¡Œå¤šä¸ªæŸ¥è¯¢
const stats = await getStats(db);
const traffic = await getTraffic(db);
const ips = await getIPs(db);

// âœ… å¥½ï¼šå¹¶è¡Œæ‰§è¡Œ
const [stats, traffic, ips] = await Promise.all([
  getStats(db),
  getTraffic(db),
  getIPs(db)
]);

// âœ… æ›´å¥½ï¼šä½¿ç”¨é¢„èšåˆ
const cached = await env.KV.get('stats:hourly', 'json');
if (cached && Date.now() - cached.timestamp < 3600000) {
  return cached.data;
}
```

**æ·»åŠ ç´¢å¼•ï¼š**
```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_traffic_events_date_timestamp 
ON traffic_events(event_date, timestamp);

CREATE INDEX IF NOT EXISTS idx_traffic_events_timestamp 
ON traffic_events(timestamp) WHERE timestamp > datetime('now', '-24 hours');
```

### ç“¶é¢ˆ 2: D1 æŸ¥è¯¢æ…¢
**ç—‡çŠ¶ï¼š** D1 æŸ¥è¯¢æ—¶é—´ > 100ms

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
1. **æ·»åŠ ç´¢å¼•** (è§ä¸Šé¢çš„ SQL)
2. **åˆ†é¡µæŸ¥è¯¢**ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
3. **é¢„èšåˆ**ï¼šä½¿ç”¨ Scheduled Worker å®šæ—¶è®¡ç®—ç»Ÿè®¡æ•°æ®
4. **ç¼“å­˜çƒ­æ•°æ®**ï¼šå°†é¢‘ç¹è®¿é—®çš„æ•°æ®å­˜å…¥ KV

```typescript
// é¢„èšåˆç¤ºä¾‹ï¼ˆScheduled Workerï¼‰
export default {
  async scheduled(event: ScheduledEvent, env: Env) {
    // æ¯å°æ—¶è®¡ç®—ä¸€æ¬¡ç»Ÿè®¡æ•°æ®
    const stats = await calculateHourlyStats(env.DB);
    await env.KV.put('stats:hourly', JSON.stringify(stats), {
      expirationTtl: 3600
    });
  }
}
```

### ç“¶é¢ˆ 3: ç½‘ç»œè¿æ¥æ…¢
**ç—‡çŠ¶ï¼š** DNS + TCP + TLS > 150ms

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
1. ä½¿ç”¨ Cloudflare CDN è¾¹ç¼˜èŠ‚ç‚¹
2. å¯ç”¨ HTTP/2 æˆ– HTTP/3
3. é…ç½®åˆç†çš„è¿æ¥å¤ç”¨
4. ä¼˜åŒ–æºç«™ç½‘ç»œ

### ç“¶é¢ˆ 4: å†…å®¹ä¼ è¾“æ…¢
**ç—‡çŠ¶ï¼š** å†…å®¹ä¼ è¾“æ—¶é—´ > 50ms

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
1. å¯ç”¨å“åº”å‹ç¼©ï¼ˆgzip/brotliï¼‰
2. å‡å°å“åº”ä½“å¤§å°
3. ä½¿ç”¨æµå¼ä¼ è¾“

```typescript
// âœ… æµå¼ä»£ç†
return fetch(upstreamUrl, request);

// âŒ é¿å…ç¼“å†²æ•´ä¸ªå“åº”
const response = await fetch(upstreamUrl, request);
const data = await response.json();
return Response.json(data);
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### Worker ä»£ç å±‚é¢
- [ ] ç§»é™¤ä¸å¿…è¦çš„æ—¥å¿—å’Œè®¡ç®—
- [ ] ä½¿ç”¨ Promise.all å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹æ“ä½œ
- [ ] é¿å…åœ¨çƒ­è·¯å¾„ä¸­ä½¿ç”¨åŒæ­¥æ“ä½œ
- [ ] ä½¿ç”¨æµå¼ä¼ è¾“ä»£ç†å“åº”
- [ ] å¯ç”¨å“åº”å‹ç¼©

### æ•°æ®åº“å±‚é¢
- [ ] ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
- [ ] é¿å…å…¨è¡¨æ‰«æï¼ˆä½¿ç”¨ LIMIT å’Œ WHEREï¼‰
- [ ] ä½¿ç”¨é¢„èšåˆå‡å°‘å®æ—¶è®¡ç®—
- [ ] å®šæœŸæ¸…ç†å†å²æ•°æ®

### ç¼“å­˜å±‚é¢
- [ ] ç¼“å­˜çƒ­ç‚¹æ•°æ®åˆ° KV
- [ ] ä½¿ç”¨ staleWhileRevalidate ç­–ç•¥
- [ ] è®¾ç½®åˆç†çš„ TTL
- [ ] å®ç°å¤šçº§ç¼“å­˜ï¼ˆè¾¹ç¼˜ + KV + D1ï¼‰

### ç½‘ç»œå±‚é¢
- [ ] å¯ç”¨ Cloudflare CDN
- [ ] é…ç½®åˆç†çš„ CORS å¤´
- [ ] ä½¿ç”¨ HTTP/2 æˆ– HTTP/3
- [ ] ä¼˜åŒ– DNS è§£æ

## ğŸ”— ç›¸å…³èµ„æº

- [Cloudflare Workers æ€§èƒ½æœ€ä½³å®è·µ](https://developers.cloudflare.com/workers/platform/limits/)
- [D1 æ•°æ®åº“ä¼˜åŒ–æŒ‡å—](https://developers.cloudflare.com/d1/platform/limits/)
- [KV å­˜å‚¨æœ€ä½³å®è·µ](https://developers.cloudflare.com/kv/best-practices/)
- [wrangler tail ä½¿ç”¨æŒ‡å—](https://developers.cloudflare.com/workers/wrangler/commands/#tail)

## ğŸ’¡ å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: Dashboard API ä¼˜åŒ–

**é—®é¢˜ï¼š** Dashboard æ¥å£å“åº”æ—¶é—´ > 500ms

**åˆ†æè¿‡ç¨‹ï¼š**
```bash
# 1. è¿è¡Œæ€§èƒ½æµ‹è¯•
node scripts/benchmark-dashboard.js

# 2. å‘ç° D1 æŸ¥è¯¢è€—æ—¶ 300ms+
# 3. ä½¿ç”¨ wrangler tail ç¡®è®¤ç“¶é¢ˆ
wrangler tail --format pretty

# 4. æ£€æŸ¥æ‰§è¡Œè®¡åˆ’
wrangler d1 execute DB --command "EXPLAIN QUERY PLAN SELECT ..."
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```typescript
// æ·»åŠ ç´¢å¼•
await env.DB.exec(`
  CREATE INDEX IF NOT EXISTS idx_traffic_events_date 
  ON traffic_events(event_date, timestamp);
`);

// ä½¿ç”¨é¢„èšåˆ
const cached = await env.KV.get('dashboard:stats', 'json');
if (cached) return cached;

const stats = await calculateStats(env.DB);
await env.KV.put('dashboard:stats', JSON.stringify(stats), {
  expirationTtl: 300 // 5åˆ†é’Ÿ
});
```

**ç»“æœï¼š** å“åº”æ—¶é—´é™ä½åˆ° 80ms (84% æå‡)

### æ¡ˆä¾‹ 2: ä¸šåŠ¡æ¥å£ä»£ç†ä¼˜åŒ–

**é—®é¢˜ï¼š** ä»£ç†å¢åŠ  200ms å»¶è¿Ÿ

**åˆ†æè¿‡ç¨‹ï¼š**
```bash
# 1. å¯¹æ¯”æµ‹è¯•
./scripts/quick-proxy-benchmark.sh

# 2. å‘ç°å¤„ç†æ—¶é—´å ä¸»è¦éƒ¨åˆ†
# 3. æ£€æŸ¥ Worker ä»£ç å‘ç°åœ¨è®°å½•æ¯ä¸ªè¯·æ±‚
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```typescript
// âŒ ä¹‹å‰ï¼šæ¯ä¸ªè¯·æ±‚éƒ½å†™ D1
await logRequest(env.DB, requestData);
return proxyResponse;

// âœ… ä¼˜åŒ–ï¼šå¼‚æ­¥æ‰¹é‡å†™å…¥
ctx.waitUntil(batchLogRequests(env.DB, requestData));
return proxyResponse;
```

**ç»“æœï¼š** ä»£ç†å»¶è¿Ÿé™ä½åˆ° 30ms (85% æå‡)

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°æ€§èƒ½é—®é¢˜éœ€è¦å¸®åŠ©ï¼š
1. è¿è¡Œå®Œæ•´çš„æ€§èƒ½æµ‹è¯•å¹¶ä¿å­˜æŠ¥å‘Š
2. ä½¿ç”¨ `wrangler tail` æ”¶é›†å®æ—¶æ—¥å¿—
3. æä¾› D1 æŸ¥è¯¢çš„ EXPLAIN ç»“æœ
4. è¯´æ˜ä¼˜åŒ–ç›®æ ‡å’Œå½“å‰ç“¶é¢ˆ

